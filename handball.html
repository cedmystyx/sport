<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Handball - Tir au But Ultra Réaliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A-Frame et modules -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@5.0.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-animation-component@6.0.0/dist/aframe-animation-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.controls.min.js"></script>
  <!-- Postprocessing (bloom, dof) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-post-processing-component@2.0.3/dist/aframe-post-processing-component.min.js"></script>
  <style>
    body {margin:0;}
    .score-ui {position: absolute; top:24px; right:24px; background:#fff9; color:#0a3a74; font-family:'Segoe UI',Arial,sans-serif; font-size:1.2em; border-radius:10px; box-shadow:0 2px 10px #0002; padding:0.7em 1.6em; z-index:10002; pointer-events:none; user-select:none; text-align:right;}
    .msg-ui {position:absolute;left:0;right:0;top:80px;text-align:center;z-index:10010;font-family:Impact,Arial,sans-serif;font-size:2em;letter-spacing:0.05em;color:#e63946;text-shadow:0 2px 20px #fff,0 0 30px #e63946aa;}
    .help-ui {position:absolute;left:24px;bottom:24px;z-index:10001;font-family:'Segoe UI',Arial,sans-serif;background:#fff8;border-radius:13px;box-shadow:0 2px 16px #00335511;padding:1em 2em;color:#184e77;font-size:1.09em;pointer-events:none;user-select:none;line-height:1.42em;}
  </style>
</head>
<body>
<div class="score-ui" id="score-ui">Tirs : <span id="shots">0</span> | Buts : <span id="goals">0</span></div>
<div class="msg-ui" id="msg-ui"></div>
<div class="help-ui">
  <b>Tir au but Handball Ultra :</b><br>
  En VR : vise avec ta main, appuie et relâche le trigger pour tirer.<br>
  Sur PC : clique ou barre espace pour tirer.<br>
  <b>Niveau max d’immersion web !</b>
</div>
<a-scene
  physics="gravity:-9.8;"
  post-processing="bloom: true; bloomStrength: 0.25; bloomThreshold: 0.8; bloomRadius: 0.5; ssao: true; ssaoRadius: 18; ssaoIntensity: 0.08"
  background="color: #e5f6ff"
  loading-screen="enabled:false">

  <a-assets>
    <!-- HDRI gymnase 360°, à remplacer par la tienne pour + réaliste -->
    <img id="sky" src="https://cdn.jsdelivr.net/gh/cedmystyx/assets/hdri-gymnasium.jpg">
    <!-- Parquet PBR + normalMap -->
    <img id="parquet" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
    <img id="parquet-norm" src="https://cdn.jsdelivr.net/gh/cedmystyx/assets/parquet-normal.jpg">
    <!-- Filet -->
    <img id="filet" src="https://cdn.pixabay.com/photo/2017/09/06/19/54/net-2726429_1280.png">
    <!-- Public sprite (image découpée) -->
    <img id="crowd-sprite" src="https://cdn.jsdelivr.net/gh/cedmystyx/assets/crowd-sprite.png">
    <!-- Ballon -->
    <img id="balltex" src="https://cdn.pixabay.com/photo/2017/01/30/22/50/handball-2023531_1280.jpg">
    <!-- Sons immersifs -->
    <audio id="goal-sound" src="https://cdn.pixabay.com/audio/2022/05/17/audio_126b8e6e53.mp3" preload="auto"></audio>
    <audio id="save-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b0e6db1.mp3" preload="auto"></audio>
    <audio id="public" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3"></audio>
    <audio id="confetti" src="https://cdn.pixabay.com/audio/2022/07/26/audio_1232a6e304.mp3"></audio>
  </a-assets>

  <!-- Skybox HDRI gymnase -->
  <a-sky src="#sky"></a-sky>

  <!-- Ambiance sonore spatiale -->
  <a-sound src="#public" position="0 2 16" spatial="true" loop="true" volume="0.6" autoplay="true"></a-sound>

  <!-- Sol avec normal map et PBR -->
  <a-box position="0 0 0"
         width="14" height="0.12" depth="28"
         src="#parquet"
         normal-map="src: #parquet-norm"
         metalness="0.25" roughness="0.19" repeat="4 8"
         static-body></a-box>

  <!-- Barrières plexi avec reflets et pubs -->
  <a-box position="0 0.55 13.7" width="14.8" height="1.1" depth="0.12"
         color="#c9e4ff" opacity="0.81" metalness="0.38" roughness="0.24" static-body></a-box>
  <a-box position="0 0.55 -13.7" width="14.8" height="1.1" depth="0.12"
         color="#c9e4ff" opacity="0.81" metalness="0.38" roughness="0.24" static-body></a-box>
  <a-box position="7.1 0.55 0" width="0.12" height="1.1" depth="27.4"
         color="#c9e4ff" opacity="0.81" metalness="0.38" roughness="0.24" static-body></a-box>
  <a-box position="-7.1 0.55 0" width="0.12" height="1.1" depth="27.4"
         color="#c9e4ff" opacity="0.81" metalness="0.38" roughness="0.24" static-body></a-box>

  <!-- Filet dynamique (animé au but) -->
  <a-plane id="filet" position="0 1.01 13.8" width="2.7" height="1.82" src="#filet"
    animation__hit="property: rotation.z; dir: alternate; from: 0; to: 3; dur: 600; easing: easeInOutQuad; startEvents: filet-hit"></a-plane>

  <!-- Public 3D (sprites découpés animés) -->
  <a-entity id="public-group">
    <a-image src="#crowd-sprite" position="-4.5 2.6 14.7" width="2.2" height="2.5" animation="property: position.y; dir: alternate; from:2.6; to:2.7; dur:2200; loop:true;"></a-image>
    <a-image src="#crowd-sprite" position="0 2.7 14.6" width="3.5" height="3" animation="property: position.y; dir: alternate; from:2.7; to:2.63; dur:1800; loop:true; delay:400;"></a-image>
    <a-image src="#crowd-sprite" position="4.5 2.6 14.7" width="2.2" height="2.5" animation="property: position.y; dir: alternate; from:2.6; to:2.7; dur:2100; loop:true;"></a-image>
  </a-entity>

  <!-- But -->
  <a-box position="0 1 13.7" width="3" height="2" depth="0.18" color="#f44336" static-body></a-box>
  <a-box position="-1.5 1 13.7" width="0.13" height="2" depth="0.22" color="#f44336" static-body></a-box>
  <a-box position="1.5 1 13.7" width="0.13" height="2" depth="0.22" color="#f44336" static-body></a-box>
  <a-box position="0 2 13.7" width="3" height="0.09" depth="0.22" color="#f44336" static-body></a-box>
  <a-box id="goal-trigger" position="0 1 13.81" width="2.6" height="1.75" depth="0.1" opacity="0" visible="false" static-body></a-box>

  <!-- Gardien IA animé -->
  <a-box id="gardien" position="0 1 13.2" width="0.9" height="1.8" depth="0.35" color="#eaf05a" shadow></a-box>
  <a-box id="gardien-bras-g" position="-0.6 1.25 13.2" width="0.4" height="0.36" depth="0.18" color="#eaf05a" shadow></a-box>
  <a-box id="gardien-bras-d" position="0.6 1.25 13.2" width="0.4" height="0.36" depth="0.18" color="#eaf05a" shadow></a-box>

  <!-- Joueur (caméra fixe, capsule collider) -->
  <a-entity id="rig"
    position="0 1.6 6.6"
    dynamic-body="shape: capsule; height: 1.7; radius: 0.3;">
    <a-entity id="camera" camera look-controls position="0 0 0"></a-entity>
    <a-entity id="rightHand"
      hand-controls="hand: right; handModelStyle: highPoly"
      super-hands></a-entity>
  </a-entity>

  <!-- Ballon, attaché à la main, lancer VR/PC -->
  <a-sphere id="handball" class="dynamic-body" position="0.35 1.1 6.7" radius="0.23"
    src="#balltex"
    dynamic-body="mass: 0.36; restitution:0.81; friction:0.33"
    real-throw penalty-ball
    shadow></a-sphere>

  <!-- Scoreboard 3D, feedback -->
  <a-entity id="scoreboard" position="0 3.5 10.7" text="value: TIRS : 0 | BUTS : 0; color: #1e90ff; width: 5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt"></a-entity>

  <!-- Confettis -->
  <a-entity id="confetti-group" visible="false"></a-entity>

  <script>
    // Score & feedback UI
    let shots = 0, goals = 0;
    const shotsUi = document.getElementById('shots');
    const goalsUi = document.getElementById('goals');
    const msgUi = document.getElementById('msg-ui');
    function updateScore(goal) {
      shots++;
      if(goal) goals++;
      shotsUi.textContent = shots;
      goalsUi.textContent = goals;
      document.getElementById('scoreboard').setAttribute('text', 'value', `TIRS : ${shots} | BUTS : ${goals}`);
    }

    // Gardien IA animé
    function animateGardien(dir) {
      // dir: -1 gauche, 0 centre, 1 droite
      let pos = [0, 0.7, -0.7][dir+1];
      document.getElementById('gardien').setAttribute('position', {x:pos, y:1, z:13.2});
      document.getElementById('gardien-bras-g').setAttribute('position', {x:pos-0.6, y:1.25, z:13.2});
      document.getElementById('gardien-bras-d').setAttribute('position', {x:pos+0.6, y:1.25, z:13.2});
      // Animation bras pour effet plongeon
      document.getElementById('gardien-bras-g').setAttribute('rotation', {x:0, y:0, z: dir==-1? -55 : -10});
      document.getElementById('gardien-bras-d').setAttribute('rotation', {x:0, y:0, z: dir==1? 55 : 10});
    }
    function resetGardien() {
      animateGardien(0);
      document.getElementById('gardien-bras-g').setAttribute('rotation', {x:0, y:0, z:-10});
      document.getElementById('gardien-bras-d').setAttribute('rotation', {x:0, y:0, z:10});
    }

    // Ballon penalty, interaction ultra réaliste VR/PC
    AFRAME.registerComponent('penalty-ball', {
      init: function () {
        this.held = true;
        this.targetPos = {x:0.35,y:1.1,z:6.7};
        this.canShoot = true;
        this.shootStart = null;
        this.el.body.type = 1;
        // PC: espace/clic, VR: trigger
        window.addEventListener('keydown', e => {
          if (this.held && this.canShoot && (e.key === " " || e.code === "Space" || e.button === 0)) this.arm();
        });
        window.addEventListener('keyup', e => {
          if (this.held && !this.canShoot && (e.key === " " || e.code === "Space" || e.button === 0)) this.shoot();
        });
        this.el.sceneEl.addEventListener('triggerdown', () => {
          if (this.held && this.canShoot) this.arm();
        });
        this.el.sceneEl.addEventListener('triggerup', () => {
          if (this.held && !this.canShoot) this.shoot();
        });
        this.resetBall();
      },
      tick: function() {
        if(this.held) {
          let rig = document.getElementById('rig');
          let hand = document.getElementById('rightHand');
          let hp = hand ? hand.object3D.getWorldPosition(new THREE.Vector3()) : rig.object3D.getWorldPosition(new THREE.Vector3());
          this.el.setAttribute('position', {x: hp.x+0.13, y: hp.y-0.2, z: hp.z+0.07});
          this.el.body.velocity.set(0,0,0);
        }
      },
      arm: function() {
        this.canShoot = false;
        this.shootStart = performance.now();
        msgUi.textContent = "Arme ton tir...";
      },
      shoot: function() {
        let force = Math.min(1.8, (performance.now()-this.shootStart)/350);
        let camera = document.getElementById('camera');
        let dir = new THREE.Vector3(0,0,1);
        camera.object3D.getWorldDirection(dir);
        let hand = document.getElementById('rightHand');
        let hx = hand ? hand.object3D.position.x : 0;
        if(hx<-0.1) dir.x-=0.35; else if(hx>0.1) dir.x+=0.35;
        dir.normalize();
        this.held = false;
        this.el.body.type = 2;
        this.el.body.velocity.set(dir.x*10*force, 3*force, dir.z*13*force);
        msgUi.textContent = "Tir !";
        // Filet dynamique au but
        setTimeout(()=>{document.getElementById('filet').emit('filet-hit');}, 650);
        // Gardien
        let gardienDir = Math.floor(Math.random()*3)-1;
        animateGardien(gardienDir);
        setTimeout(()=>{this.checkGoal(gardienDir, dir.x);}, 700);
      },
      checkGoal: function(gardienDir, ballDX) {
        let goal = false, save = false;
        if(Math.abs(gardienDir - Math.sign(ballDX))<1.1 && Math.abs(ballDX)<0.7) save = true;
        else goal = true;
        updateScore(goal);
        if(goal) {
          document.getElementById('goal-sound').play();
          msgUi.textContent = "BUT !";
          showConfetti();
        } else {
          document.getElementById('save-sound').play();
          msgUi.textContent = "ARRET !";
        }
        setTimeout(()=>{
          this.resetBall();
          resetGardien();
          hideConfetti();
        }, 1500);
      },
      resetBall: function() {
        this.held = true;
        this.canShoot = true;
        this.shootStart = null;
        this.el.body.type = 1;
        this.el.setAttribute('position', this.targetPos);
        this.el.body.velocity.set(0,0,0);
        msgUi.textContent = "";
      }
    });

    // Lancer VR basé sur la vélocité de la main (ultra immersion)
    AFRAME.registerComponent('real-throw', {
      init: function() {
        this.el.sceneEl.addEventListener('triggerup', () => {
          const ball = this.el;
          const hand = document.getElementById('rightHand');
          const controller = hand.components['tracked-controls']?.controller;
          if (controller && controller.linearVelocity && !ball.components['penalty-ball'].held) {
            ball.body.velocity.set(
              controller.linearVelocity.x * 15,
              Math.max(controller.linearVelocity.y * 17, 2.4),
              controller.linearVelocity.z * 20
            );
          }
        });
      }
    });

    // Confettis effet
    function showConfetti() {
      let confetti = document.getElementById('confetti-group');
      confetti.innerHTML = '';
      confetti.setAttribute('visible', true);
      document.getElementById('confetti').play();
      for(let i=0;i<26;i++){
        let particle = document.createElement('a-sphere');
        particle.setAttribute('radius', 0.07+Math.random()*0.06);
        particle.setAttribute('color', ['#ffec40', '#e63946','#00bfff','#7cffc8','#fff'][Math.floor(Math.random()*5)]);
        particle.setAttribute('position', {x:-0.7+1.4*Math.random(), y:3.5+Math.random(), z:10.6+Math.random()*2});
        particle.setAttribute('animation__fall', `property: position; to: ${-0.7+1.4*Math.random()} 0.2 ${10.6+Math.random()*2}; dur:1200; easing:easeIn;`);
        confetti.appendChild(particle);
      }
    }
    function hideConfetti() {
      let confetti = document.getElementById('confetti-group');
      confetti.setAttribute('visible', false);
      confetti.innerHTML = '';
    }

    // But (optionnel pour filet-hit plus précis)
    AFRAME.registerComponent('goal-trigger', {
      init: function () {
        this.el.addEventListener('collide', (e) => {
          document.getElementById('filet').emit('filet-hit');
          document.getElementById('goal-sound').play();
        });
      }
    });
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('goal-trigger').setAttribute('goal-trigger','');
    });

  </script>
</a-scene>
</body>
</html>
