<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Handball Arena ‚Äì Le vrai jeu web</title>
  <meta name="description" content="Le handball web jouable, fun, extensible, solide. Pr√©vu pour des milliers de joueurs, scoring, progression, et +." />
  <link href="https://fonts.googleapis.com/css?family=Orbitron:900|Montserrat:400,700&display=swap" rel="stylesheet" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@5.0.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.controls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <style>
    /* ... Ton CSS inchang√© ... */
  </style>
</head>
<body>
  <!-- UI inchang√©e -->
  <div class="score-ui" id="score-ui" aria-live="polite" role="region" aria-label="Score et statistiques du jeu">
    <span aria-hidden="true" style="font-size:1.1em;">üèê</span> Ballons : <span id="shots" style="font-weight:bold;">0</span>
    <span aria-hidden="true" style="font-size:1.1em; margin-left: 1em;">ü•Ö</span> Buts : <span id="goals" style="font-weight:bold;">0</span>
    <br />
    <small style="font-size:0.9em; color:#fff8;">Combo: <span id="combo">0</span></small>
  </div>

  <div class="msg-ui" id="msg-ui" aria-live="assertive" role="alert" aria-atomic="true"></div>

  <div class="nav-ui" id="nav-ui" role="navigation" aria-label="Contr√¥les du jeu">
    <button id="resetBallBtn" type="button">Reset Ballon</button>
    <button id="resetPlayerBtn" type="button">Reset Joueur</button>
    <button id="toggleMusicBtn" type="button">Musique</button>
    <button id="showHelpBtn" type="button">Aide</button>
  </div>

  <div id="handballOverlay" role="dialog" aria-modal="true" aria-labelledby="gameTitle" aria-describedby="gameDesc">
    <div>
      <div id="gameTitle" class="game-title">Handball Arena ‚Äì Web Game</div>
      <div id="gameDesc" class="game-desc">
        <b>Simulation r√©aliste, scoring, combos, rebonds, physique solide.</b><br />
        <b>Multiplateforme VR/PC/Mobile.</b><br />
        <span style="color:#b7f;">Pr√™t pour multi, leaderboards, progression, succ√®s, bots, skins.</span><br /><br />
        <span style="font-style: italic;">Joue pour exploser les records, d√©fie tes amis !</span>
      </div>
      <button class="game-btn" id="startBtn" type="button" aria-label="D√©marrer le jeu">Jouer !</button>
    </div>
  </div>

  <a-scene physics="gravity: -9.8;" loading-screen="enabled: false" id="scene" embedded vr-mode-ui="enterVRButton: true">
    <a-assets>
      <a-asset-item id="handball-ball" src="handball_1964/scene.gltf"></a-asset-item>
      <audio id="goalSound" src="sounds/goal.wav" preload="auto"></audio>
      <audio id="hitSound" src="sounds/hit.wav" preload="auto"></audio>
      <audio id="backgroundMusic" src="sounds/bg_music.mp3" preload="auto" loop></audio>
    </a-assets>

    <!-- Environnement -->
    <a-entity environment="preset: stadium; groundColor: #444; skyColor: #88aaff; fog: 0.7;"></a-entity>

    <!-- Sol -->
    <a-plane rotation="-90 0 0" width="50" height="30" color="#6a7" static-body></a-plane>

    <!-- But -->
    <a-box id="goal" position="0 2.6 -14" depth="0.4" height="2" width="5" color="#0ff" opacity="0.3" static-body></a-box>

    <!-- Ballon (avec mod√®le glTF conserv√©) -->
    <a-entity id="ball" gltf-model="#handball-ball" scale="0.2 0.2 0.2" position="0 1.2 -3" dynamic-body="mass: 0.45; linearDamping: 0.1; angularDamping: 0.15;" 
              class="clickable" 
              shadow="cast: true; receive: true"
              sound="src: #hitSound; on: collision; volume: 0.4"></a-entity>

    <!-- Joueur (sphere, simple) -->
    <a-entity id="player" position="0 1 -6" 
              geometry="primitive: sphere; radius: 0.5" 
              material="color: #1188ff" 
              dynamic-body="mass: 75; linearDamping: 0.95; angularDamping: 0.95;" 
              kinematic-body 
              shadow="cast: true; receive: true">
    </a-entity>

    <!-- Cam√©ra -->
    <a-entity id="cameraRig" position="0 1.6 6">
      <a-camera id="camera" wasd-controls="acceleration: 25" look-controls="pointerLockEnabled: true" fov="80" near="0.01" far="1000">
        <a-cursor color="#1e90ff" fuse="true" fuseTimeout="1500"></a-cursor>
      </a-camera>
    </a-entity>
  </a-scene>

  <script>
    (() => {
      const ball = document.getElementById('ball');
      const player = document.getElementById('player');
      const goal = document.getElementById('goal');
      const shotsEl = document.getElementById('shots');
      const goalsEl = document.getElementById('goals');
      const comboEl = document.getElementById('combo');
      const msgEl = document.getElementById('msg-ui');
      const overlay = document.getElementById('handballOverlay');
      const startBtn = document.getElementById('startBtn');
      const resetBallBtn = document.getElementById('resetBallBtn');
      const resetPlayerBtn = document.getElementById('resetPlayerBtn');
      const toggleMusicBtn = document.getElementById('toggleMusicBtn');
      const showHelpBtn = document.getElementById('showHelpBtn');
      const bgMusic = document.getElementById('backgroundMusic');
      const goalSound = document.getElementById('goalSound');

      let shots = 0;
      let goals = 0;
      let combo = 0;
      let lastGoalTime = 0;
      let comboTimeout = null;
      let isDragging = false;

      // Reset ball physiquement √† sa position initiale
      function resetBall() {
        ball.setAttribute('position', { x: 0, y: 1.2, z: -3 });
        const body = ball.body;
        if (body) {
          body.velocity.set(0, 0, 0);
          body.angularVelocity.set(0, 0, 0);
          body.position.set(0, 1.2, -3);
          body.quaternion.set(0, 0, 0, 1);
          body.wakeUp();
        }
      }

      // Reset joueur physiquement √† sa position initiale
      function resetPlayer() {
        player.setAttribute('position', { x: 0, y: 1, z: -6 });
        const body = player.body;
        if (body) {
          body.velocity.set(0, 0, 0);
          body.angularVelocity.set(0, 0, 0);
          body.position.set(0, 1, -6);
          body.quaternion.set(0, 0, 0, 1);
          body.wakeUp();
        }
      }

      // Mise √† jour du score dans l'UI
      function updateScoreUI() {
        shotsEl.textContent = shots;
        goalsEl.textContent = goals;
        comboEl.textContent = combo;
      }

      // Affiche un message temporaire √† l'√©cran
      function showMessage(text, duration = 2200) {
        msgEl.textContent = text;
        if (comboTimeout) clearTimeout(comboTimeout);
        comboTimeout = setTimeout(() => {
          msgEl.textContent = '';
        }, duration);
      }

      // Gestion du but marqu√©
      function onGoal() {
        goals++;
        combo++;
        shots++;
        updateScoreUI();
        goalSound.play();
        showMessage(`GOAL ! ü•Ö Combo x${combo}`, 3200);
        lastGoalTime = Date.now();

        // Remet en place balle et joueur apr√®s un court d√©lai
        setTimeout(() => {
          resetBall();
          resetPlayer();
        }, 800);
      }

      // Gestion d'un tir effectu√©
      function onShot() {
        shots++;
        updateScoreUI();
        showMessage('Ballon lanc√© ! üèê', 1600);
      }

      // √âviter que le combo s'accumule trop longtemps sans marquer
      function checkComboTimeout() {
        if (combo > 0 && (Date.now() - lastGoalTime) > 5000) {
          combo = 0;
          updateScoreUI();
          showMessage('Combo perdu...', 1800);
        }
      }

      // Mouvements contr√¥l√©s du joueur (limit√©s et fluides)
      function movePlayerTo(x, z) {
        // Limites du terrain ¬±22m en X, -16 √† 6 en Z par ex.
        const clampedX = Math.min(22, Math.max(-22, x));
        const clampedZ = Math.min(6, Math.max(-16, z));
        const body = player.body;
        if (body) {
          body.position.x = clampedX;
          body.position.z = clampedZ;
          body.wakeUp();
        }
        player.setAttribute('position', { x: clampedX, y: 1, z: clampedZ });
      }

      // Pour d√©placer joueur en fonction de la souris (ou tactile)
      function onPointerMove(event) {
        if (!isDragging) return;
        let clientX, clientY;
        if (event.touches) {
          clientX = event.touches[0].clientX;
          clientY = event.touches[0].clientY;
        } else {
          clientX = event.clientX;
          clientY = event.clientY;
        }
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        // Transforme coordonn√©es √©cran vers coordonn√©es terrain (approx)
        const x = (clientX / winW) * 44 - 22;  // -22 √† +22
        const z = 6 - (clientY / winH) * 22;   // 6 √† -16
        movePlayerTo(x, z);
      }

      // Tirer la balle avec force dans la direction "devant" du joueur
      function shootBall() {
        if (!ball.body || !player.body) return;

        // Position et direction
        const playerPos = player.body.position;
        const ballPos = ball.body.position;
        const direction = new CANNON.Vec3(0, 0.2, -1); // tir l√©g√®rement en l'air vers l'avant
        direction.normalize();

        // D√©placer la balle devant le joueur
        ball.body.position.set(playerPos.x, playerPos.y + 0.5, playerPos.z - 1);
        ball.body.velocity.setZero();
        ball.body.angularVelocity.setZero();
        ball.body.wakeUp();

        // Appliquer une force impulsive
        const forceMagnitude = 15;
        const impulse = direction.scale(forceMagnitude);
        ball.body.applyImpulse(impulse, ball.body.position);

        onShot();
      }

      // Event collision balle <-> but
      ball.addEventListener('collide', (e) => {
        if (!e.detail.body) return;
        if (goal.body && e.detail.body.id === goal.body.id) {
          onGoal();
        }
      });

      // D√©marrage du jeu
      startBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
        shots = 0;
        goals = 0;
        combo = 0;
        updateScoreUI();
        resetBall();
        resetPlayer();
        bgMusic.play().catch(() => {}); // pour √©viter erreur si auto-play bloqu√©
      });

      // Reset ball
      resetBallBtn.addEventListener('click', () => {
        resetBall();
        showMessage('Ballon r√©initialis√©');
      });

      // Reset player
      resetPlayerBtn.addEventListener('click', () => {
        resetPlayer();
        showMessage('Joueur r√©initialis√©');
      });

      // Toggle musique
      toggleMusicBtn.addEventListener('click', () => {
        if (bgMusic.paused) {
          bgMusic.play();
          showMessage('Musique activ√©e');
        } else {
          bgMusic.pause();
          showMessage('Musique d√©sactiv√©e');
        }
      });

      // Aide (simple alert)
      showHelpBtn.addEventListener('click', () => {
        alert("D√©place la souris (ou tactile) pour bouger le joueur.\nClique gauche pour tirer le ballon.\nBut : marquer dans le but bleu.");
      });

      // Dragging flag gestion
      window.addEventListener('mousedown', () => { isDragging = true; });
      window.addEventListener('mouseup', () => { isDragging = false; });
      window.addEventListener('touchstart', () => { isDragging = true; });
      window.addEventListener('touchend', () => { isDragging = false; });

      // Mouvement joueur via souris/tactile
      window.addEventListener('mousemove', onPointerMove);
      window.addEventListener('touchmove', onPointerMove);

      // Tir au clic gauche
      window.addEventListener('click', (evt) => {
        if (overlay.style.display !== 'none') return; // jeu non d√©marr√©
        if (!isDragging) return; // √©viter tirs accidentels
        shootBall();
      });

      // Intervalle combo timeout
      setInterval(checkComboTimeout, 1000);

      // Au chargement, reset la balle et joueur
      window.addEventListener('load', () => {
        resetBall();
        resetPlayer();
        updateScoreUI();
      });
    })();
  </script>
</body>
</html>
