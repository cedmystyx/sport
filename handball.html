<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Handball Arena ‚Äì Jeu Web VR</title>
  <meta name="description" content="Handball Arena : jeu web VR, scoring, combos, physique." />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Polices -->
  <link href="https://fonts.googleapis.com/css?family=Orbitron:900|Montserrat:400,700&display=swap" rel="stylesheet" />
  
  <!-- A-Frame + Physique + Extras + Environnement + Super Hands -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@5.0.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.controls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>

  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden; background: #0a0a2a; color: #eee;
      font-family: 'Montserrat', sans-serif;
      user-select: none;
    }
    .score-ui {
      position: fixed; top: 10px; left: 10px; font-size: 1.2em; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 6px;
      z-index: 9999; pointer-events: none;
      font-weight: 700;
    }
    .msg-ui {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      font-size: 1.4em; background: rgba(0,0,0,0.7); padding: 12px 20px; border-radius: 8px;
      pointer-events: none; color: #55ff55; font-weight: 700;
      z-index: 9999;
      min-width: 220px;
      text-align: center;
    }
    .nav-ui {
      position: fixed; bottom: 10px; right: 10px;
      z-index: 9999;
    }
    .nav-ui button {
      background: #222244; border: none; color: #eef; font-weight: 700;
      padding: 8px 14px; margin-left: 8px; border-radius: 6px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      transition: background 0.3s ease;
    }
    .nav-ui button:hover {
      background: #3366ff;
    }
    #handballOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: linear-gradient(135deg, #000022, #000044);
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; color: #99bbff;
      font-family: 'Orbitron', sans-serif;
      z-index: 10000;
      text-align: center;
      padding: 20px;
    }
    #handballOverlay .game-title {
      font-size: 3em; font-weight: 900; margin-bottom: 0.2em;
      text-shadow: 0 0 12px #44f, 0 0 24px #77bbff;
    }
    #handballOverlay .game-desc {
      font-size: 1.3em; margin-bottom: 2em;
      line-height: 1.4;
      color: #aaccee;
    }
    #handballOverlay .game-btn {
      background: #3366ff;
      color: #fff;
      border: none;
      font-size: 1.6em;
      padding: 12px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 0 18px #5599ff;
      transition: background 0.4s ease;
    }
    #handballOverlay .game-btn:hover {
      background: #5588ff;
      box-shadow: 0 0 28px #77bbff;
    }
  </style>
</head>
<body>

  <div class="score-ui" id="score-ui" aria-live="polite" role="region" aria-label="Score et statistiques">
    üèê Ballons : <span id="shots">0</span> &nbsp;ü•Ö Buts : <span id="goals">0</span><br/>
    Combo : <span id="combo">0</span>
  </div>

  <div class="msg-ui" id="msg-ui" aria-live="assertive" role="alert" aria-atomic="true"></div>

  <div class="nav-ui" id="nav-ui" role="navigation" aria-label="Contr√¥les du jeu">
    <button id="resetBallBtn" type="button">Reset Ballon</button>
    <button id="resetPlayerBtn" type="button">Reset Joueur</button>
    <button id="toggleMusicBtn" type="button">Musique</button>
    <button id="showHelpBtn" type="button">Aide</button>
  </div>

  <div id="handballOverlay" role="dialog" aria-modal="true" aria-labelledby="gameTitle" aria-describedby="gameDesc">
    <div>
      <div id="gameTitle" class="game-title">Handball Arena</div>
      <div id="gameDesc" class="game-desc">
        <b>Simulation r√©aliste, scoring, combos, rebonds, physique solide.</b><br/>
        Multiplateforme VR / PC / Mobile.<br/>
        Pr√™t pour multi, leaderboards, progression, succ√®s, bots, skins.<br/><br/>
        <i>Joue pour exploser les records, d√©fie tes amis !</i>
      </div>
      <button class="game-btn" id="startBtn" type="button" aria-label="D√©marrer le jeu">Jouer !</button>
    </div>
  </div>

  <a-scene
    id="scene"
    physics="gravity: -9.8"
    vr-mode-ui="enterVRButton: true"
    embedded
    loading-screen="enabled: false"
    background="color: #001022"
  >
    <a-assets>
      <a-asset-item id="handball-ball" src="handball_1964/scene.gltf"></a-asset-item>
      <audio id="goalSound" src="sounds/goal.wav" preload="auto"></audio>
      <audio id="hitSound" src="sounds/hit.wav" preload="auto"></audio>
      <audio id="backgroundMusic" src="sounds/bg_music.mp3" preload="auto" loop></audio>
    </a-assets>

    <!-- Lumi√®re ambiante -->
    <a-light type="ambient" color="#888"></a-light>
    <!-- Lumi√®re directionnelle pour √©clairage -->
    <a-light type="directional" color="#fff" intensity="0.9" position="5 10 7" castShadow="true"></a-light>

    <!-- Environnement stade -->
    <a-entity environment="preset: stadium; groundColor: #334433; skyColor: #4477cc; fog: 0.7;"></a-entity>

    <!-- Sol statique -->
    <a-plane rotation="-90 0 0" width="50" height="30" color="#4a6" static-body receive-shadow="true"></a-plane>

    <!-- But -->
    <a-box id="goal" position="0 2.6 -14" depth="0.4" height="2" width="5" color="#0ff" opacity="0.35" static-body></a-box>

    <!-- Ballon -->
    <a-entity
      id="ball"
      gltf-model="#handball-ball"
      scale="0.2 0.2 0.2"
      position="0 1.2 -3"
      dynamic-body="mass: 0.45; linearDamping: 0.1; angularDamping: 0.15;"
      shadow="cast: true; receive: true"
      sound="src: #hitSound; on: collision; volume: 0.4"
      class="clickable"
    ></a-entity>

    <!-- Joueur simple (sphere) -->
    <a-entity
      id="player"
      geometry="primitive: sphere; radius: 0.5"
      material="color: #0055ff; opacity: 0.85"
      position="0 0.5 3"
      dynamic-body="mass: 2"
      shadow="cast: true"
    ></a-entity>

    <!-- Cam√©ra avec contr√¥les clavier + VR controllers -->
    <a-entity id="cameraRig" position="0 1.6 7">
      <a-camera
        id="camera"
        wasd-controls-enabled="true"
        look-controls="pointerLockEnabled: true"
        position="0 0 0"
        camera
        user-height="1.6"
        raycaster="objects: .clickable"
        cursor="fuse: false; rayOrigin: mouse"
      >
        <a-cursor
          id="cursor"
          fuse="false"
          color="#55aaff"
          raycaster="objects: .clickable"
          animation__click="property: scale; startEvents: click; from: 1 1 1; to: 0.7 0.7 0.7; dur: 150; dir: alternate"
        ></a-cursor>
      </a-camera>

      <!-- Contr√¥leurs VR -->
      <a-entity hand-controls="left" super-hands="colliderEvent: collisions; colliderEventProperty: els; grabStartButtons: triggerdown; grabEndButtons: triggerup"></a-entity>
      <a-entity hand-controls="right" super-hands="colliderEvent: collisions; colliderEventProperty: els; grabStartButtons: triggerdown; grabEndButtons: triggerup"></a-entity>
    </a-entity>

  </a-scene>

<script>
  (() => {
    const overlay = document.getElementById('handballOverlay');
    const startBtn = document.getElementById('startBtn');
    const scoreUI = document.getElementById('score-ui');
    const msgUI = document.getElementById('msg-ui');

    const shotsSpan = document.getElementById('shots');
    const goalsSpan = document.getElementById('goals');
    const comboSpan = document.getElementById('combo');

    const resetBallBtn = document.getElementById('resetBallBtn');
    const resetPlayerBtn = document.getElementById('resetPlayerBtn');
    const toggleMusicBtn = document.getElementById('toggleMusicBtn');
    const showHelpBtn = document.getElementById('showHelpBtn');

    const ball = document.getElementById('ball');
    const player = document.getElementById('player');
    const goal = document.getElementById('goal');
    const bgMusic = document.getElementById('backgroundMusic');
    const goalSound = document.getElementById('goalSound');

    let shots = 0;
    let goals = 0;
    let combo = 0;
    let lastGoalTime = 0;
    const comboTimeout = 5000; // ms pour reset combo

    let gameStarted = false;

    // Fonction de remise √† z√©ro du ballon
    function resetBall() {
      ball.setAttribute('position', { x: 0, y: 1.2, z: -3 });
      ball.body.velocity.set(0, 0, 0);
      ball.body.angularVelocity.set(0, 0, 0);
    }

    // Fonction de remise √† z√©ro du joueur
    function resetPlayer() {
      player.setAttribute('position', { x: 0, y: 0.5, z: 3 });
      player.body.velocity.set(0, 0, 0);
      player.body.angularVelocity.set(0, 0, 0);
    }

    // Affichage message temporaire
    function showMessage(text, duration = 2500) {
      msgUI.textContent = text;
      msgUI.style.opacity = '1';
      setTimeout(() => {
        msgUI.style.opacity = '0';
      }, duration);
    }

    // Met √† jour le score dans l'UI
    function updateScore() {
      shotsSpan.textContent = shots;
      goalsSpan.textContent = goals;
      comboSpan.textContent = combo;
    }

    // D√©tection de but simple : si ballon traverse zone but en Z < -14, score +1
    function checkGoal() {
      const pos = ball.getAttribute('position');
      if (pos.z < -13.5 && Math.abs(pos.x) < 2.5 && pos.y < 2.5 && pos.y > 0.2) {
        goals++;
        combo++;
        shots++;
        updateScore();
        goalSound.play();
        showMessage('üéâ But !');
        resetBall();
      }
    }

    // Gestion combo timeout
    function updateCombo() {
      if (combo > 0) {
        const now = Date.now();
        if (now - lastGoalTime > comboTimeout) {
          combo = 0;
          updateScore();
        }
      }
    }

    // Initialisation apr√®s clic "Jouer !"
    startBtn.addEventListener('click', () => {
      gameStarted = true;
      overlay.style.display = 'none';
      scoreUI.style.display = 'block';
      msgUI.style.opacity = '0.8';
      bgMusic.volume = 0.3;
      bgMusic.play();
    });

    // Boutons UI
    resetBallBtn.addEventListener('click', () => {
      if (gameStarted) resetBall();
    });
    resetPlayerBtn.addEventListener('click', () => {
      if (gameStarted) resetPlayer();
    });
    toggleMusicBtn.addEventListener('click', () => {
      if (bgMusic.paused) {
        bgMusic.play();
        toggleMusicBtn.textContent = 'Musique';
      } else {
        bgMusic.pause();
        toggleMusicBtn.textContent = 'Musique Off';
      }
    });
    showHelpBtn.addEventListener('click', () => {
      alert(
        'Contr√¥les:\n' +
        '- WASD pour d√©placer la cam√©ra\n' +
        '- Clic / trigger pour interagir avec le ballon\n' +
        '- R√©initialiser ballon / joueur avec les boutons\n' +
        '- VR : utiliser contr√¥leurs pour saisir et lancer le ballon\n' +
        '- Marquer des buts en lan√ßant dans la zone bleue devant\n' +
        '- Combo si buts rapides'
      );
    });

    // D√©tection collision ballon avec but (simplifi√©e)
    ball.addEventListener('collide', (e) => {
      if (!gameStarted) return;
      // Si collision avec la box du but
      if (e.detail.body.el.id === 'goal') {
        checkGoal();
        lastGoalTime = Date.now();
      }
    });

    // Cycle principal avec update combo + score
    AFRAME.scenes[0].addEventListener('loaded', () => {
      updateScore();
      scoreUI.style.display = 'none';
      msgUI.style.opacity = '0';

      // Tick loop classique
      AFRAME.registerComponent('game-loop', {
        tick: function () {
          if (!gameStarted) return;
          updateCombo();
          // On peut ajouter plus de logique ici (combo, vitesse ballon, ...)
        }
      });
      document.querySelector('a-scene').setAttribute('game-loop', '');
    });
  })();
</script>

</body>
</html>
