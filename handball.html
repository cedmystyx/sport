<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Handball VR - Main Thématique + Contrôles VR Avancés</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.controls.min.js"></script>
  <!-- Pour les mains stylisées -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-extras@0.1.4/dist/aframe-physics-extras.min.js"></script>
  <style>
    body {margin:0;}
    .score-ui {position: absolute; top:24px; right:24px; background:#fff9; color:#0a3a74; font-family:'Segoe UI',Arial,sans-serif; font-size:1.2em; border-radius:10px; box-shadow:0 2px 10px #0002; padding:0.7em 1.6em; z-index:10002; pointer-events:none; user-select:none; text-align:right;}
    .help-ui {position:absolute;left:24px;top:24px;z-index:10001;font-family:'Segoe UI',Arial,sans-serif;background:#fff8;border-radius:13px;box-shadow:0 2px 16px #00335511;padding:1em 2em;color:#184e77;font-size:1.1em;pointer-events:none;user-select:none;line-height:1.42em;}
  </style>
  <script>
    // --- Physique, score, feedback comme plus haut
    function updateScoreUI() {
      let sc = parseInt(localStorage.getItem('handball_score')||"0",10);
      let ui = document.getElementById("score-ui");
      if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${sc}</span>`;
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      let scoreDiv = document.createElement('div');
      scoreDiv.id = "score-ui";
      scoreDiv.className = "score-ui";
      document.body.appendChild(scoreDiv);
      let helpDiv = document.createElement('div');
      helpDiv.className = "help-ui";
      helpDiv.innerHTML = "<b>VR Handball - Thème Mains</b><br>Déplace-toi avec le stick gauche, <b>appuie sur le stick</b> pour sprinter<br>Jump avec bouton A / X ou stick droit vers l'avant<br>Lance avec la main et trigger, ou clique.<br>Les mains géantes te suivent partout !";
      document.body.appendChild(helpDiv);
      setTimeout(()=>{helpDiv.style.display="none"}, 12000);
      updateScoreUI();
      localStorage.setItem('handball_score', "0");
      updateScoreUI();
    });
    window.addEventListener('storage', updateScoreUI);

    // --- Contrôles VR avancés (sprint, saut, direction par controlleur)
    // Ajout de la composante de direction
    AFRAME.registerComponent('handball-vr-move', {
      schema: {
        speed: {default: 0.09},
        sprint: {default: 0.2},
        jump: {default: 0.33}
      },
      init: function () {
        this.direction = new THREE.Vector3();
        this.velocity = new THREE.Vector3();
        this.isSprinting = false;
        this.isJumping = false;
        this.grounded = true;
        this.jumpCooldown = 0;
        this.lastY = 0;
        this.el.sceneEl.addEventListener('enter-vr',()=>{this.vr=true;});
        this.el.sceneEl.addEventListener('exit-vr',()=>{this.vr=false;});
      },
      tick: function (time, dt) {
        let rig = this.el;
        let leftHand = document.getElementById("leftHand");
        let gamepad;
        if (leftHand && leftHand.components["hand-controls"] && leftHand.components["hand-controls"].controller) {
          gamepad = leftHand.components["hand-controls"].controller;
        }
        // Mouvement directionnel
        let moveX=0,moveY=0;
        if (gamepad && gamepad.axes && gamepad.axes.length>=2) {
          moveX = gamepad.axes[2] || gamepad.axes[0] || 0;
          moveY = -gamepad.axes[3] || -gamepad.axes[1] || 0;
        }
        // Direction = là où regarde la main gauche (stick)
        let dir = new THREE.Vector3(moveX,0,moveY);
        if (dir.length()>1) dir.normalize();
        // Sprint
        let sprint = false;
        if (gamepad && gamepad.buttons && gamepad.buttons[3] && gamepad.buttons[3].pressed) sprint = true;
        // Saut
        let jump = false;
        if ((gamepad && gamepad.buttons && gamepad.buttons[4] && gamepad.buttons[4].pressed) || (gamepad && gamepad.buttons && gamepad.buttons[0] && gamepad.buttons[0].pressed)) jump = true;
        // Appliquer le mouvement
        let speed = sprint ? this.data.sprint : this.data.speed;
        let pos = rig.object3D.position;
        pos.x += dir.x * speed;
        pos.z += dir.z * speed;
        // Gestion du sol
        if (pos.y<=1.6) { this.grounded=true; pos.y=1.6; }
        // Saut
        if (jump && this.grounded && this.jumpCooldown<=0) {
          this.velocity.y = this.data.jump;
          this.isJumping = true;
          this.grounded = false;
          this.jumpCooldown = 25;
        }
        // Gravité
        if (!this.grounded) {
          this.velocity.y -= 0.013;
          pos.y += this.velocity.y;
          if (pos.y<=1.6) { pos.y=1.6; this.velocity.y=0; this.isJumping=false; this.grounded=true; }
        }
        if (this.jumpCooldown>0) this.jumpCooldown--;
        rig.setAttribute('position',pos);
      }
    });

    // --- Suivi des mains géantes décoratives
    AFRAME.registerComponent('giant-hands-follow', {
      schema: {},
      tick: function() {
        let rig = document.getElementById('rig');
        if (!rig) return;
        let pos = rig.object3D.position;
        let rot = rig.object3D.rotation;
        // Main gauche
        this.el.setAttribute('position',`${pos.x-1.3} ${pos.y+0.7} ${pos.z+1.5}`);
        this.el.setAttribute('rotation',`0 ${(rot.y*180/Math.PI)-20} 0`);
      }
    });
    AFRAME.registerComponent('giant-hands-follow-r', {
      schema: {},
      tick: function() {
        let rig = document.getElementById('rig');
        if (!rig) return;
        let pos = rig.object3D.position;
        let rot = rig.object3D.rotation;
        // Main droite
        this.el.setAttribute('position',`${pos.x+1.3} ${pos.y+0.7} ${pos.z+1.5}`);
        this.el.setAttribute('rotation',`0 ${(rot.y*180/Math.PI)+20} 0`);
      }
    });

    // --- Ballon tir physique
    AFRAME.registerComponent('throwable', {
      schema: { force: {default: 17} },
      init: function () {
        this.el.addEventListener('grab-end', evt => {
          let hand = evt.detail.hand;
          let dir = new THREE.Vector3(0,0,-1);
          hand.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y, force.z);
          // Ajout du spin
          this.el.body.angularVelocity.set(
            Math.random()*15-7,
            Math.random()*6-3,
            Math.random()*15-7
          );
        });
        this.el.addEventListener('click', evt => {
          let cam = document.querySelector('[camera]');
          if (!cam) return;
          let dir = new THREE.Vector3(0,0,-1);
          cam.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y+2, force.z);
          this.el.body.angularVelocity.set(
            Math.random()*16-8,
            Math.random()*7-3.5,
            Math.random()*16-8
          );
        });
        this.el.addEventListener('body-loaded', ()=>{
          this.el.body.addEventListener('sleep', ()=>{
            let pos = this.el.object3D.position;
            if (Math.abs(pos.x) > 25 || pos.y < -2 || Math.abs(pos.z) > 30) {
              this.el.setAttribute("position","0 1.2 -6");
              this.el.body.velocity.set(0,0,0);
              this.el.body.angularVelocity.set(0,0,0);
            }
          });
        });
      }
    });
    // Détection but
    AFRAME.registerComponent('goal-detect', {
      schema: {scoreEl: {type: "selector"}},
      init: function () {
        this.goal = false;
        this.el.addEventListener('collide', (e) => {
          if (e.detail.body.el && e.detail.body.el.id==="goal-trigger") {
            if (!this.goal) {
              this.goal = true;
              let current = parseInt(localStorage.getItem('handball_score')||"0",10);
              current++;
              localStorage.setItem('handball_score', current);
              if (this.data.scoreEl) this.data.scoreEl.setAttribute("text","value",`Score : ${current}`);
              this.el.setAttribute("material","color","#6fff81");
              let snd = document.getElementById("goal-audio");
              if (snd) snd.play();
              setTimeout(()=>{
                this.el.setAttribute("material","color","#ffb300");
                this.el.body.velocity.set(0,0,0);
                this.el.body.angularVelocity.set(0,0,0);
                this.el.setAttribute("position","0 1.2 -6");
                this.goal = false;
              }, 1200);
              let ui = document.getElementById("score-ui");
              if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${current}</span>`;
            }
          }
        });
      }
    });
  </script>
</head>
<body>
  <a-scene physics="gravity:-9.8; restitution:0.81; friction:0.32;" background="color: #b8e0f7" loading-screen="enabled:false">
    <a-assets>
      <audio id="goal-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12e6c7b2bb.mp3"></audio>
      <audio id="ambiance" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" preload="auto"></audio>
    </a-assets>
    <!-- Décor thème "mains" : gradins en forme de main, terrain stylisé -->
    <a-box position="0 0 0" width="12" height="0.1" depth="24" color="#d3f1ff" static-body></a-box>
    <!-- Doigts gradins -->
    <a-cylinder position="-4.5 1.5 13.5" radius="0.4" height="3.1" color="#ffe3c6" segments-radial="6" rotation="0 0 9"></a-cylinder>
    <a-cylinder position="-2.5 1.4 14.1" radius="0.5" height="3.5" color="#ffd8a8" segments-radial="6" rotation="0 0 7"></a-cylinder>
    <a-cylinder position="0 1.5 14.7" radius="0.55" height="3.8" color="#ffd1a1" segments-radial="6"></a-cylinder>
    <a-cylinder position="2.5 1.4 14.1" radius="0.5" height="3.5" color="#ffd8a8" segments-radial="6" rotation="0 0 -7"></a-cylinder>
    <a-cylinder position="4.5 1.5 13.5" radius="0.4" height="3.1" color="#ffe3c6" segments-radial="6" rotation="0 0 -9"></a-cylinder>
    <!-- Paume gradins -->
    <a-box position="0 0.8 13.7" width="7.8" height="1.44" depth="5.3" color="#ffe7b5"></a-box>
    <!-- Autres éléments "mains" stylisés dans le décor -->
    <a-torus position="0 2.3 -11" radius="4" radius-tubular="0.13" color="#c2b2f7" rotation="90 0 0"></a-torus>
    <a-torus position="0 2.1 0" radius="6" radius-tubular="0.09" color="#aac7ff" rotation="90 0 0"></a-torus>
    <!-- But (avant, cadre solide) -->
    <a-box position="0 1 10.8" width="3" height="2" depth="0.25" color="#1e90ff" static-body></a-box>
    <a-box position="-1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="0 2 10.8" width="3" height="0.09" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-plane position="0 1.01 11" width="2.8" height="1.95" rotation="0 0 0" color="#fff" opacity="0.13"></a-plane>
    <!-- Trigger but -->
    <a-box id="goal-trigger" position="0 1 10.6" width="2.6" height="1.75" depth="0.1" opacity="0" visible="false" static-body></a-box>
    <!-- Ballon handball physique -->
    <a-sphere id="handball" class="raycastable grabbable" position="0 1.2 -6" radius="0.22" color="#ffb300" dynamic-body="mass: 0.36; linearDamping:0.07; angularDamping:0.13; restitution:0.81; friction:0.33" super-hands throwable goal-detect="scoreEl: #score-text" shadow="cast:true"></a-sphere>
    <!-- Suivi des mains géantes décoratives -->
    <a-entity id="giantHandL" giant-hands-follow>
      <a-cylinder radius="0.38" height="2.1" color="#fff7e6" segments-radial="6" position="0 0 0"></a-cylinder>
      <a-sphere radius="0.43" color="#ffe6bd" position="0 1.1 0.15"></a-sphere>
      <a-cylinder radius="0.19" height="0.8" color="#ffe2a9" segments-radial="5" position="-0.33 1.4 0.13" rotation="0 0 17"></a-cylinder>
      <a-cylinder radius="0.18" height="0.7" color="#ffe2a9" segments-radial="5" position="0.33 1.38 0.13" rotation="0 0 -17"></a-cylinder>
    </a-entity>
    <a-entity id="giantHandR" giant-hands-follow-r>
      <a-cylinder radius="0.38" height="2.1" color="#fff7e6" segments-radial="6" position="0 0 0"></a-cylinder>
      <a-sphere radius="0.43" color="#ffe6bd" position="0 1.1 0.15"></a-sphere>
      <a-cylinder radius="0.19" height="0.8" color="#ffe2a9" segments-radial="5" position="-0.33 1.4 0.13" rotation="0 0 17"></a-cylinder>
      <a-cylinder radius="0.18" height="0.7" color="#ffe2a9" segments-radial="5" position="0.33 1.38 0.13" rotation="0 0 -17"></a-cylinder>
    </a-entity>
    <!-- Rig joueur + mains VR directionnelles -->
    <a-entity id="rig" position="0 1.6 -8" handball-vr-move>
      <a-entity id="camera" camera wasd-controls look-controls position="0 0 0"></a-entity>
      <!-- Main gauche VR -->
      <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: highPoly; color: #e5b285" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8"></a-entity>
      <!-- Main droite VR -->
      <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: highPoly; color: #d7a878" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8"></a-entity>
    </a-entity>
    <a-entity id="score-text" position="0 3.5 3" text="value: Score : 0; color: #1e90ff; width: 4.5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt" visible="true"></a-entity>
    <a-sky color="#b8e0f7"></a-sky>
  </a-scene>
  <audio id="ambiance-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" autoplay loop></audio>
</body>
</html>
