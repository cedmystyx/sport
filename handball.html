<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Handball VR - Bot R√©el & Physique Maximale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <script src="https://unpkg.com/aframe-teleport-controls@^0.4.0/dist/aframe-teleport-controls.min.js"></script>
  <style>
    body {margin:0;}
    .score-ui {position: absolute; top:24px; right:24px; background:#fff9; color:#0a3a74; font-family:'Segoe UI',Arial,sans-serif; font-size:1.2em; border-radius:10px; box-shadow:0 2px 10px #0002; padding:0.7em 1.6em; z-index:10002; pointer-events:none; user-select:none; text-align:right;}
    .bot-ui {position:absolute;left:24px;top:24px;z-index:10001;font-family:'Segoe UI',Arial,sans-serif;background:#fff8;border-radius:13px;box-shadow:0 2px 16px #00335511;padding:1em 2em;color:#184e77;font-size:1.1em;pointer-events:none;user-select:none;line-height:1.42em;}
  </style>
  <script>
    let botHasBall = false, playerHasBall = false, gameStarted = false, botCooldown = 0, botTarget = null;
    // Utils
    function dist(a, b) {let dx=a.x-b.x,dy=a.y-b.y,dz=a.z-b.z;return Math.sqrt(dx*dx+dy*dy+dz*dz);}
    // BOT IA
    function botThink() {
      if(!gameStarted) return setTimeout(botThink, 30);
      const bot = document.getElementById('bot');
      const ball = document.getElementById('handball');
      const player = document.getElementById('rig');
      if(!bot||!ball||!player) return setTimeout(botThink, 30);

      let botPos = bot.object3D.position;
      let ballPos = ball.object3D.position;
      let playerPos = player.object3D.position;

      // Si le bot tient la balle, il la lance vers le but (ou vers toi s'il d√©fend)
      if(botHasBall) {
        if(botCooldown<=0) {
          // Lancer vers le but
          let target = {x:0, y:1.2, z:11.5};
          // Si le joueur est devant et proche, il tente de viser le joueur
          if(dist(botPos,playerPos)<3) target = {x:playerPos.x, y:1.3, z:playerPos.z};
          let ballBody = ball.body;
          ball.setAttribute('dynamic-body','mass:0.35;linearDamping:0.07;angularDamping:0.13');
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.6} ${botPos.z+0.8}`);
          ballBody.velocity.set(0,0,0); ballBody.angularVelocity.set(0,0,0);
          let dir = new THREE.Vector3(target.x-botPos.x, target.y-botPos.y, target.z-botPos.z).normalize();
          ballBody.velocity.set(dir.x*18, dir.y*12+Math.random()*1.5, dir.z*18);
          ballBody.angularVelocity.set(Math.random()*12-6, Math.random()*4-2, Math.random()*12-6);
          botHasBall = false;
          botCooldown = 40 + Math.random()*30;
        } else botCooldown--;
        setTimeout(botThink, 30); return;
      }

      // Si le joueur tient la balle, le bot tente de s'approcher et attraper
      if(playerHasBall) {
        // Si assez proche, "vole" la balle !
        if(dist(botPos, ballPos)<1.0) {
          playerHasBall = false;
          botHasBall = true;
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.6} ${botPos.z+0.7}`);
          ball.body.velocity.set(0,0,0);
          ball.body.angularVelocity.set(0,0,0);
          showBotText("üòà Le bot t'a vol√© la balle !");
          setTimeout(()=>{showBotText("");}, 1200);
        } else {
          // S'approche de la balle
          moveBotToward(bot, ballPos, 0.11);
        }
        setTimeout(botThink, 30); return;
      }

      // Si la balle est libre, le bot essaie de l'attraper
      if(!botHasBall) {
        // Si assez proche
        if(dist(botPos, ballPos)<1.0 && ballPos.y<2) {
          botHasBall = true;
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.6} ${botPos.z+0.7}`);
          ball.body.velocity.set(0,0,0);
          ball.body.angularVelocity.set(0,0,0);
          showBotText("ü§ñ Le bot prend la balle !");
          setTimeout(()=>{showBotText("");}, 1200);
        } else {
          moveBotToward(bot, ballPos, 0.09+Math.random()*0.04);
        }
        setTimeout(botThink, 30); return;
      }
      setTimeout(botThink, 30);
    }
    function moveBotToward(bot, target, speed=0.09) {
      let pos = bot.object3D.position;
      let dir = {x: target.x-pos.x, y: 0, z: target.z-pos.z};
      let len = Math.sqrt(dir.x*dir.x+dir.z*dir.z);
      if(len>0.02) {
        dir.x/=len; dir.z/=len;
        bot.setAttribute('position',{x:pos.x+dir.x*speed,y:pos.y,z:pos.z+dir.z*speed});
      }
    }
    // UI bot
    function showBotText(txt) {
      let el = document.getElementById('bot-ui');
      if(el) el.innerText = txt;
    }
    // Detection prise balle par joueur
    function playerGrab() { playerHasBall = true; }
    function playerRelease() { playerHasBall = false; }

    // SCORE UI
    function updateScoreUI() {
      let sc = parseInt(localStorage.getItem('handball_score')||"0",10);
      let ui = document.getElementById("score-ui");
      if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${sc}</span>`;
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      let scoreDiv = document.createElement('div');
      scoreDiv.id = "score-ui";
      scoreDiv.className = "score-ui";
      document.body.appendChild(scoreDiv);
      let botDiv = document.createElement('div');
      botDiv.id = 'bot-ui'; botDiv.className = 'bot-ui'; botDiv.innerText = '';
      document.body.appendChild(botDiv);
      updateScoreUI();
      // Reset score √† chaque chargement
      localStorage.setItem('handball_score', "0");
      updateScoreUI();
      // D√©marre la logique bot apr√®s chargement
      setTimeout(()=>{gameStarted=true;botThink();},600);
    });
    window.addEventListener('storage', updateScoreUI);

    // PHYSIQUE AVANC√âE
    AFRAME.registerComponent('throwable', {
      schema: { force: {default: 16} },
      init: function () {
        this.el.addEventListener('grab-start',()=>{playerGrab();});
        this.el.addEventListener('grab-end', evt => {
          playerRelease();
          let hand = evt.detail.hand;
          let dir = new THREE.Vector3(0,0,-1);
          hand.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y, force.z);
          // Ajout du spin
          this.el.body.angularVelocity.set(
            Math.random()*15-7,
            Math.random()*6-3,
            Math.random()*15-7
          );
        });
        this.el.addEventListener('click', evt => {
          playerRelease();
          let cam = document.querySelector('[camera]');
          if (!cam) return;
          let dir = new THREE.Vector3(0,0,-1);
          cam.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y+2, force.z);
          this.el.body.angularVelocity.set(
            Math.random()*16-8,
            Math.random()*7-3.5,
            Math.random()*16-8
          );
        });
        this.el.addEventListener('body-loaded', ()=>{
          this.el.body.addEventListener('sleep', ()=>{
            let pos = this.el.object3D.position;
            if (Math.abs(pos.x) > 25 || pos.y < -2 || Math.abs(pos.z) > 30) {
              this.el.setAttribute("position","0 1.2 -6");
              this.el.body.velocity.set(0,0,0);
              this.el.body.angularVelocity.set(0,0,0);
            }
          });
        });
      }
    });
    // D√©tection but
    AFRAME.registerComponent('goal-detect', {
      schema: {scoreEl: {type: "selector"}},
      init: function () {
        this.goal = false;
        this.el.addEventListener('collide', (e) => {
          if (e.detail.body.el && e.detail.body.el.id==="goal-trigger") {
            if (!this.goal) {
              this.goal = true;
              let current = parseInt(localStorage.getItem('handball_score')||"0",10);
              current++;
              localStorage.setItem('handball_score', current);
              if (this.data.scoreEl) this.data.scoreEl.setAttribute("text","value",`Score : ${current}`);
              this.el.setAttribute("material","color","#6fff81");
              let snd = document.getElementById("goal-audio");
              if (snd) snd.play();
              setTimeout(()=>{
                this.el.setAttribute("material","color","#ffb300");
                this.el.body.velocity.set(0,0,0);
                this.el.body.angularVelocity.set(0,0,0);
                this.el.setAttribute("position","0 1.2 -6");
                this.goal = false;
              }, 1200);
              let ui = document.getElementById("score-ui");
              if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${current}</span>`;
            }
          }
        });
      }
    });
  </script>
</head>
<body>
  <a-scene physics="gravity:-9.8; restitution:0.73;" background="color: #d1e8f7" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .raycastable" loading-screen="enabled:false">
    <a-assets>
      <audio id="goal-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12e6c7b2bb.mp3"></audio>
      <audio id="ambiance" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" preload="auto"></audio>
    </a-assets>
    <!-- Terrain handball, murs physiques -->
    <a-box position="0 0 0" width="12" height="0.1" depth="24" color="#c2dafc" static-body></a-box>
    <a-box position="6.1 1 0" width="0.2" height="2" depth="24.2" color="#888" opacity="0.09" static-body></a-box>
    <a-box position="-6.1 1 0" width="0.2" height="2" depth="24.2" color="#888" opacity="0.09" static-body></a-box>
    <a-box position="0 1 -12.1" width="12.2" height="2" depth="0.2" color="#888" opacity="0.07" static-body></a-box>
    <!-- But (avant, cadre solide) -->
    <a-box position="0 1 10.8" width="3" height="2" depth="0.25" color="#1e90ff" static-body></a-box>
    <a-box position="-1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="0 2 10.8" width="3" height="0.09" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-plane position="0 1.01 11" width="2.8" height="1.95" rotation="0 0 0" color="#fff" opacity="0.13"></a-plane>
    <!-- Trigger but -->
    <a-box id="goal-trigger" position="0 1 10.6" width="2.6" height="1.75" depth="0.1" opacity="0" visible="false" static-body></a-box>
    <!-- Bot joueur -->
    <a-cylinder id="bot" position="0 1 6" radius="0.33" height="2" color="#7dd6f6" segments-radial="6"></a-cylinder>
    <a-sphere position="0 2.24 6.1" radius="0.22" color="#0a3a74"></a-sphere>
    <!-- Ballon handball physique -->
    <a-sphere id="handball" class="raycastable grabbable" position="0 1.2 -6" radius="0.22" color="#ffb300" dynamic-body="mass: 0.35; linearDamping:0.06; angularDamping:0.12; restitution:0.77; friction:0.38" super-hands throwable goal-detect="scoreEl: #score-text" shadow="cast:true"></a-sphere>
    <!-- Rig joueur + mains VR -->
    <a-entity id="rig" position="0 1.6 -8" movement-controls="fly: false; speed: 0.7; acceleration: 250">
      <a-entity id="camera" camera wasd-controls look-controls position="0 0 0"></a-entity>
      <a-entity id="leftHand" hand-controls="hand: left; color: #e5b285" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8" teleport-controls="hand: left; cameraRig: #rig; teleportOrigin: #camera; button: trigger"></a-entity>
      <a-entity id="rightHand" hand-controls="hand: right; color: #d7a878" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8" teleport-controls="hand: right; cameraRig: #rig; teleportOrigin: #camera; button: trigger"></a-entity>
    </a-entity>
    <a-entity id="score-text" position="0 3.5 3" text="value: Score : 0; color: #1e90ff; width: 4.5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt" visible="true"></a-entity>
    <a-sky color="#d1e8f7"></a-sky>
  </a-scene>
  <audio id="ambiance-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" autoplay loop></audio>
</body>
</html>
