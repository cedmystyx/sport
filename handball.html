<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Handball VR - Simulation Physique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <script src="https://unpkg.com/aframe-teleport-controls@^0.4.0/dist/aframe-teleport-controls.min.js"></script>
  <style>
    body {margin:0;}
    .score-ui {
      position: absolute; top: 24px; right: 24px;
      background: #fff9;
      color: #0a3a74;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 1.2em;
      border-radius: 10px;
      box-shadow: 0 2px 10px #0002;
      padding: 0.7em 1.6em;
      z-index: 10002;
      pointer-events: none;
      user-select: none;
      text-align: right;
    }
  </style>
  <script>
    // Retour menu
    AFRAME.registerComponent('menu-back', {
      init: function () {
        this.el.addEventListener('click', function () {
          window.location.href = 'chargement.html';
        });
        this.el.addEventListener('triggerdown', function () {
          window.location.href = 'chargement.html';
        });
      }
    });
    // Détection but
    AFRAME.registerComponent('goal-detect', {
      schema: {scoreEl: {type: "selector"}},
      init: function () {
        this.goal = false;
        this.el.addEventListener('collide', (e) => {
          if (e.detail.body.el && e.detail.body.el.id==="goal-trigger") {
            if (!this.goal) {
              this.goal = true;
              let current = parseInt(localStorage.getItem('handball_score')||"0",10);
              current++;
              localStorage.setItem('handball_score', current);
              if (this.data.scoreEl) this.data.scoreEl.setAttribute("text","value",`Score : ${current}`);
              this.el.setAttribute("material","color","#6fff81");
              let snd = document.getElementById("goal-audio");
              if (snd) snd.play();
              setTimeout(()=>{
                this.el.setAttribute("material","color","#ffb300");
                this.el.body.velocity.set(0,0,0);
                this.el.body.angularVelocity.set(0,0,0);
                this.el.setAttribute("position","0 1.2 -6");
                this.goal = false;
              }, 1000);
              let ui = document.getElementById("score-ui");
              if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${current}</span>`;
            }
          }
        });
      }
    });
    // Ballon attrapable/lancable
    AFRAME.registerComponent('throwable', {
      schema: { force: {default: 15} },
      init: function () {
        this.el.addEventListener('grab-end', evt => {
          let hand = evt.detail.hand;
          let dir = new THREE.Vector3(0,0,-1);
          hand.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y, force.z);
        });
        this.el.addEventListener('click', evt => {
          let cam = document.querySelector('[camera]');
          if (!cam) return;
          let dir = new THREE.Vector3(0,0,-1);
          cam.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y+2, force.z);
        });
        this.el.addEventListener('body-loaded', ()=>{
          this.el.body.addEventListener('sleep', ()=>{
            let pos = this.el.object3D.position;
            if (Math.abs(pos.x) > 25 || pos.y < -2 || Math.abs(pos.z) > 30) {
              this.el.setAttribute("position","0 1.2 -6");
              this.el.body.velocity.set(0,0,0);
              this.el.body.angularVelocity.set(0,0,0);
            }
          });
        });
      }
    });
    // Score UI
    function updateScoreUI() {
      let sc = parseInt(localStorage.getItem('handball_score')||"0",10);
      let ui = document.getElementById("score-ui");
      if (ui) ui.innerHTML = `Score<br><span style="font-size:1.25em;font-weight:bold;">${sc}</span>`;
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      let scoreDiv = document.createElement('div');
      scoreDiv.id = "score-ui";
      scoreDiv.className = "score-ui";
      document.body.appendChild(scoreDiv);
      updateScoreUI();
      // Reset score à chaque chargement
      localStorage.setItem('handball_score', "0");
      updateScoreUI();
    });
    window.addEventListener('storage', updateScoreUI);
  </script>
</head>
<body>
  <a-scene
    physics="gravity:-9.8; restitution:0.62;"
    background="color: #d1e8f7"
    cursor="rayOrigin: mouse; fuse: false"
    raycaster="objects: .raycastable"
    loading-screen="enabled:false"
  >
    <a-assets>
      <audio id="goal-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12e6c7b2bb.mp3"></audio>
      <audio id="ambiance" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Terrain handball, murs physiques -->
    <a-box position="0 0 0" width="12" height="0.1" depth="24" color="#c2dafc" static-body></a-box>
    <!-- Murs latéraux -->
    <a-box position="6.1 1 0" width="0.2" height="2" depth="24.2" color="#888" opacity="0.09" static-body></a-box>
    <a-box position="-6.1 1 0" width="0.2" height="2" depth="24.2" color="#888" opacity="0.09" static-body></a-box>
    <!-- Mur fond -->
    <a-box position="0 1 -12.1" width="12.2" height="2" depth="0.2" color="#888" opacity="0.07" static-body></a-box>
    <!-- But (avant, cadre solide) -->
    <a-box position="0 1 10.8" width="3" height="2" depth="0.25" color="#1e90ff" static-body></a-box>
    <a-box position="-1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="0 2 10.8" width="3" height="0.09" depth="0.27" color="#1e90ff" static-body></a-box>
    <!-- Filet (avant) -->
    <a-plane position="0 1.01 11" width="2.8" height="1.95" rotation="0 0 0" color="#fff" opacity="0.13"></a-plane>
    <!-- Trigger but -->
    <a-box id="goal-trigger"
      position="0 1 10.6"
      width="2.6" height="1.75" depth="0.1"
      opacity="0" visible="false"
      static-body></a-box>
    <!-- But arrière décor -->
    <a-box position="0 1 -10.8" width="3" height="2" depth="0.25" color="#1e90ff" opacity="0.4" static-body></a-box>
    <!-- Gradins stylisés -->
    <a-box position="0 0.2 13.5" width="14" height="0.8" depth="1.5" color="#c3a68a"></a-box>
    <a-box position="0 0.7 14.5" width="14" height="0.6" depth="1" color="#bfa57a"></a-box>
    <a-box position="0 1.1 15.2" width="14" height="0.3" depth="0.8" color="#bba56a"></a-box>
    <!-- Ballon handball physique -->
    <a-sphere id="handball"
      class="raycastable grabbable"
      position="0 1.2 -6"
      radius="0.22"
      color="#ffb300"
      dynamic-body="mass: 0.35; linearDamping:0.05; angularDamping:0.13; restitution:0.75"
      super-hands
      throwable
      goal-detect="scoreEl: #score-text"
      shadow="cast:true"
    ></a-sphere>
    <!-- Rig joueur + mains VR -->
    <a-entity id="rig"
      position="0 1.6 -8"
      movement-controls="fly: false; speed: 0.7; acceleration: 250">
      <a-entity id="camera" camera wasd-controls look-controls position="0 0 0"></a-entity>
      <!-- Main gauche VR -->
      <a-entity id="leftHand"
        hand-controls="hand: left; color: #e5b285"
        shadow="cast: true"
        super-hands
        raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22"
        line="color: #228b22; opacity: 0.8"
        teleport-controls="hand: left; cameraRig: #rig; teleportOrigin: #camera; button: trigger"
      ></a-entity>
      <!-- Main droite VR -->
      <a-entity id="rightHand"
        hand-controls="hand: right; color: #d7a878"
        shadow="cast: true"
        super-hands
        raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22"
        line="color: #228b22; opacity: 0.8"
        teleport-controls="hand: right; cameraRig: #rig; teleportOrigin: #camera; button: trigger"
      ></a-entity>
      <!-- Bouton retour menu -->
      <a-entity id="retour-menu"
        position="-0.9 0.6 -1.25"
        geometry="primitive: cylinder; radius: 0.22; height: 0.12"
        material="color: #d32f2f; metalness: 0.7; roughness: 0.2; opacity: 0.93"
        class="raycastable menu-button"
        menu-back>
        <a-entity geometry="primitive: circle; radius: 0.2"
                  position="0 0.065 0"
                  material="color: #fff176; opacity:0.78; emissive: #fff176; emissiveIntensity:0.76"></a-entity>
        <a-entity
          text="value: MENU; align: center; color: #222; width: 0.85; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt"
          position="0 0.09 0.01"
          scale="1 1 1"
          rotation="-90 0 0"
        ></a-entity>
      </a-entity>
    </a-entity>
    <!-- Score texte dans la scène -->
    <a-entity id="score-text"
      position="0 3.5 3"
      text="value: Score : 0; color: #1e90ff; width: 4.5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt"
      visible="true"
    ></a-entity>
    <a-sky color="#d1e8f7"></a-sky>
  </a-scene>
  <audio id="ambiance-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" autoplay loop></audio>
</body>
</html>
