<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Handball VR - Jeu Complet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.3/dist/super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.controls.min.js"></script>
  <style>
    body {margin:0;}
    .score-ui {position: absolute; top:24px; right:24px; background:#fff9; color:#0a3a74; font-family:'Segoe UI',Arial,sans-serif; font-size:1.2em; border-radius:10px; box-shadow:0 2px 10px #0002; padding:0.7em 1.6em; z-index:10002; pointer-events:none; user-select:none; text-align:right;}
    .timer-ui {position:absolute;top:24px;left:24px;z-index:10001;font-family:'Segoe UI',Arial,sans-serif;background:#fff8;border-radius:13px;box-shadow:0 2px 16px #00335511;padding:.6em 1.6em;color:#184e77;font-size:1.3em;pointer-events:none;user-select:none;}
    .msg-ui {position:absolute;left:0;right:0;top:85px;text-align:center;z-index:10010;font-family:Impact,Arial,sans-serif;font-size:2em;letter-spacing:0.05em;color:#e63946;text-shadow:0 2px 20px #fff,0 0 30px #e63946aa;}
    .help-ui {position:absolute;left:24px;bottom:24px;z-index:10001;font-family:'Segoe UI',Arial,sans-serif;background:#fff8;border-radius:13px;box-shadow:0 2px 16px #00335511;padding:1em 2em;color:#184e77;font-size:1.09em;pointer-events:none;user-select:none;line-height:1.42em;}
  </style>
  <script>
    // --- UI & GAME STATE
    let scoreJ = 0, scoreBot = 0, chronoSec = 60, playing = false, ballInHand = false, lastHolder = "player";
    function updateScoreUI() {
      let ui = document.getElementById("score-ui");
      if (ui) ui.innerHTML = `üèÜ <b>${scoreJ}</b> ‚Äî <b>${scoreBot}</b> ü§ñ`;
      let sb = document.getElementById("scoreboard");
      if(sb) sb.setAttribute("text", "value", scoreJ+" - "+scoreBot);
    }
    function updateTimerUI() {
      let ui = document.getElementById("timer-ui");
      if (ui) ui.innerHTML = chronoSec>0 ? `‚è∞ <b>${Math.floor(chronoSec/60)}:${("0"+(chronoSec%60)).slice(-2)}</b>` : "‚è∞ <b>0:00</b>";
    }
    function showMessage(txt, dur=1800) {
      let el = document.getElementById('msg-ui');
      if (!el) {
        el = document.createElement('div'); el.id = 'msg-ui'; el.className = 'msg-ui';
        document.body.appendChild(el);
      }
      el.innerText = txt; el.style.display = 'block';
      setTimeout(()=>{el.style.display='none';},dur);
    }
    function resetBall(center=0) {
      let ball = document.getElementById('handball');
      if(ball) {
        ball.setAttribute("position",`${center} 1.2 0`);
        ball.body.velocity.set(0,0,0); ball.body.angularVelocity.set(0,0,0);
      }
      ballInHand = false; lastHolder="player";
    }
    function resetBot() {
      let bot = document.getElementById('bot');
      bot.setAttribute("position","0 1 6");
      bot.setAttribute("rotation","0 0 0");
    }
    function resetGardien() {
      let gardien = document.getElementById('gardien');
      gardien.setAttribute("position","0 1 10.3");
    }
    function restartGame() {
      scoreJ = 0; scoreBot = 0; chronoSec = 60; playing = true;
      updateScoreUI(); updateTimerUI(); resetBall();
      resetBot();
      resetGardien();
      showMessage("NOUVELLE PARTIE !");
    }
    // --- Timer
    function startTimer() {
      let t = setInterval(()=>{
        if(!playing) return clearInterval(t);
        chronoSec--;
        updateTimerUI();
        if(chronoSec<=0) {
          playing=false;
          let winner = scoreJ>scoreBot ? "VICTOIRE !" : (scoreJ==scoreBot ? "√âGALIT√â" : "D√©faite...");
          showMessage(winner+" (R pour rejouer)",3800);
          clearInterval(t);
        }
      },1000);
    }
    // --- Contr√¥les universels VR + PC (stick+clavier), style foot
    AFRAME.registerComponent('foot-move', {
      schema: {
        speed: {default: 0.11},
        sprint: {default: 0.19},
        jump: {default: 0.32}
      },
      init: function () {
        this.direction = new THREE.Vector3();
        this.velocity = new THREE.Vector3();
        this.grounded = true;
        this.jumpCooldown = 0;
        this.rotY = 0;
      },
      tick: function () {
        if(!playing) return;
        let rig = this.el;
        let leftHand = document.getElementById("leftHand");
        let rightHand = document.getElementById("rightHand");
        let gamepadL = leftHand && leftHand.components["hand-controls"] ? leftHand.components["hand-controls"].controller : null;
        let gamepadR = rightHand && rightHand.components["hand-controls"] ? rightHand.components["hand-controls"].controller : null;
        // D√©placement VR
        let moveX=0,moveY=0;
        if (gamepadL && gamepadL.axes && gamepadL.axes.length>=2) {
          moveX = gamepadL.axes[2] || gamepadL.axes[0] || 0;
          moveY = -gamepadL.axes[3] || -gamepadL.axes[1] || 0;
        }
        // PC clavier
        if (!AFRAME.utils.device.checkHeadsetConnected()) {
          if (window.keyState) {
            moveX = (window.keyState["KeyD"]||window.keyState["ArrowRight"]?1:0)-(window.keyState["KeyQ"]||window.keyState["KeyA"]||window.keyState["ArrowLeft"]?1:0);
            moveY = (window.keyState["KeyZ"]||window.keyState["ArrowUp"]?1:0)-(window.keyState["KeyS"]||window.keyState["ArrowDown"]?1:0);
          }
        }
        let dir = new THREE.Vector3(moveX,0,moveY);
        if (dir.length()>1) dir.normalize();
        // Rotation snap (stick droit horizontal ou clavier E/R)
        if (gamepadR && gamepadR.axes && Math.abs(gamepadR.axes[2])>0.5) {
          this.rotY += Math.sign(gamepadR.axes[2])*2.5;
        }
        if (!AFRAME.utils.device.checkHeadsetConnected() && window.keyState) {
          if(window.keyState["KeyE"]) this.rotY += 2;
          if(window.keyState["KeyR"]) this.rotY -= 2;
        }
        let sprint = false;
        if (gamepadL && gamepadL.buttons && gamepadL.buttons[3] && gamepadL.buttons[3].pressed) sprint = true;
        if (!AFRAME.utils.device.checkHeadsetConnected() && window.keyState && window.keyState["ShiftLeft"]) sprint = true;
        let jump = false;
        if ((gamepadL && gamepadL.buttons && gamepadL.buttons[4] && gamepadL.buttons[4].pressed) || (gamepadL && gamepadL.buttons && gamepadL.buttons[0] && gamepadL.buttons[0].pressed)) jump = true;
        if (!AFRAME.utils.device.checkHeadsetConnected() && window.keyState && window.keyState["Space"]) jump = true;
        let speed = sprint ? this.data.sprint : this.data.speed;
        let pos = rig.object3D.position;
        // Appliquer la rotation
        let theta = this.rotY*Math.PI/180;
        let moveDir = new THREE.Vector3(
          Math.cos(theta)*dir.x - Math.sin(theta)*dir.z,
          0,
          Math.sin(theta)*dir.x + Math.cos(theta)*dir.z
        );
        pos.x += moveDir.x * speed;
        pos.z += moveDir.z * speed;
        // Saut
        if (pos.y<=1.6) { this.grounded=true; pos.y=1.6; }
        if (jump && this.grounded && this.jumpCooldown<=0) {
          this.velocity.y = this.data.jump;
          this.grounded = false;
          this.jumpCooldown = 20;
        }
        if (!this.grounded) {
          this.velocity.y -= 0.016;
          pos.y += this.velocity.y;
          if (pos.y<=1.6) { pos.y=1.6; this.velocity.y=0; this.grounded=true; }
        }
        if (this.jumpCooldown>0) this.jumpCooldown--;
        rig.setAttribute('position',pos);
        rig.setAttribute('rotation',{x:0,y:this.rotY,z:0});
      }
    });
    // Gestion clavier desktop
    window.keyState = {};
    document.addEventListener('keydown',e=>window.keyState[e.code]=true);
    document.addEventListener('keyup',e=>window.keyState[e.code]=false);

    // --- Ballon tir & possession
    AFRAME.registerComponent('throwable', {
      schema: { force: {default: 16} },
      init: function () {
        this.el.addEventListener('grab-start',()=>{ ballInHand=true; lastHolder='player'; });
        this.el.addEventListener('grab-end', evt => {
          ballInHand = false;
          let hand = evt.detail.hand;
          let dir = new THREE.Vector3(0,0,-1);
          hand.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y, force.z);
          this.el.body.angularVelocity.set(
            Math.random()*14-7,
            Math.random()*5-2,
            Math.random()*12-6
          );
        });
        this.el.addEventListener('click', evt => {
          ballInHand = false;
          let cam = document.querySelector('[camera]');
          if (!cam) return;
          let dir = new THREE.Vector3(0,0,-1);
          cam.object3D.getWorldDirection(dir);
          dir.normalize();
          let force = dir.multiplyScalar(this.data.force);
          this.el.body.velocity.set(force.x, force.y+2, force.z);
          this.el.body.angularVelocity.set(
            Math.random()*13-6,
            Math.random()*6-3,
            Math.random()*13-6
          );
        });
        this.el.addEventListener('body-loaded', ()=>{
          this.el.body.addEventListener('sleep', ()=>{
            let pos = this.el.object3D.position;
            if (Math.abs(pos.x) > 25 || pos.y < -2 || Math.abs(pos.z) > 30) {
              this.el.setAttribute("position","0 1.2 0");
              this.el.body.velocity.set(0,0,0);
              this.el.body.angularVelocity.set(0,0,0);
            }
          });
        });
      }
    });
    // --- Bot IA simple
    let botHasBall = false, botCooldown = 0;
    function botThink() {
      if(!playing) return setTimeout(botThink, 40);
      const bot = document.getElementById('bot');
      const ball = document.getElementById('handball');
      let botPos = bot.object3D.position;
      let ballPos = ball.object3D.position;
      // Si le joueur a la balle, bot d√©fend
      if(ballInHand && !botHasBall) {
        let player = document.getElementById('rig').object3D.position;
        let t = {x: player.x*0.56, y:1, z: (player.z+10.5)*0.5};
        moveBotToward(bot, t, 0.13);
        // Interception
        if(dist(botPos, ballPos)<1.1 && Math.abs(botPos.y-ballPos.y)<1.2) {
          botHasBall=true; ballInHand=false; lastHolder='bot';
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.82} ${botPos.z+0.43}`);
          ball.body.velocity.set(0,0,0); ball.body.angularVelocity.set(0,0,0);
          showMessage("Le bot intercepte !");
          botCooldown = 18+Math.random()*12;
        }
        return setTimeout(botThink, 40);
      }
      // Si le bot a la balle, attaque
      if(botHasBall) {
        if(botCooldown<=0) {
          let target = {x:0.1+1*(Math.random()-0.5), y:1.13+Math.random()*0.2, z:11.5+Math.random()*0.19};
          let ballBody = ball.body;
          ball.setAttribute('dynamic-body','mass:0.36;linearDamping:0.07;angularDamping:0.13;restitution:0.78;friction:0.32');
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.82} ${botPos.z+0.43}`);
          ballBody.velocity.set(0,0,0); ballBody.angularVelocity.set(0,0,0);
          let dir = new THREE.Vector3(target.x-botPos.x, target.y-(botPos.y+0.82), target.z-botPos.z).normalize();
          let power = 18 + Math.random()*2.5;
          ballBody.velocity.set(dir.x*power, dir.y*10+Math.random()*2.2, dir.z*power);
          ballBody.angularVelocity.set(
            Math.random()*16-8,
            Math.random()*5-2.5,
            Math.random()*14-7
          );
          botHasBall = false; lastHolder='bot';
          showMessage("Le bot tire !");
        } else botCooldown--;
        return setTimeout(botThink, 40);
      }
      // Si balle libre, le bot fonce
      if(!botHasBall && !ballInHand) {
        let t = {x: ballPos.x, y:1, z: ballPos.z-0.6};
        moveBotToward(bot, t, 0.15);
        // Attrape la balle
        if(dist(botPos, ballPos)<1.1 && Math.abs(botPos.y-ballPos.y)<1.2) {
          botHasBall=true; ballInHand=false; lastHolder='bot';
          ball.setAttribute('position',`${botPos.x} ${botPos.y+0.82} ${botPos.z+0.43}`);
          ball.body.velocity.set(0,0,0); ball.body.angularVelocity.set(0,0,0);
          showMessage("Le bot prend la balle !");
          botCooldown = 18+Math.random()*12;
        }
        return setTimeout(botThink, 40);
      }
      setTimeout(botThink, 40);
    }
    function moveBotToward(bot, target, speed=0.12) {
      let pos = bot.object3D.position;
      let dir = {x: target.x-pos.x, y: 0, z: target.z-pos.z};
      let len = Math.sqrt(dir.x*dir.x+dir.z*dir.z);
      if(len>0.02) {
        dir.x/=len; dir.z/=len;
        bot.setAttribute('position',{x:pos.x+dir.x*speed,y:pos.y,z:pos.z+dir.z*speed});
      }
    }
    function dist(a, b) {let dx=a.x-b.x,dy=a.y-b.y,dz=a.z-b.z;return Math.sqrt(dx*dx+dy*dy+dz*dz);}
    // --- Gardien IA
    setInterval(()=>{
      let gardien = document.getElementById('gardien');
      let ball = document.getElementById('handball');
      if(gardien && ball && playing) {
        let bx = ball.object3D.position.x;
        gardien.object3D.position.x += (bx-gardien.object3D.position.x)*0.19;
      }
    },45);

    // --- Buts & score
    AFRAME.registerComponent('goal-detect', {
      schema: {scoreEl: {type: "selector"}},
      init: function () {
        this.goal = false;
        this.el.addEventListener('collide', (e) => {
          // Si collision avec le gardien, arr√™t !
          if (e.detail.body.el && e.detail.body.el.id==="gardien") {
            showMessage("Arr√™t du gardien !",1300);
            this.el.body.velocity.set(0,0,0);
            this.el.body.angularVelocity.set(0,0,0);
            setTimeout(()=>{resetBall();},900);
            return;
          }
          // Si collision but
          if (e.detail.body.el && e.detail.body.el.id==="goal-trigger") {
            if (!this.goal && playing) {
              this.goal = true;
              if(lastHolder==='player') {
                scoreJ++; showMessage("BUT !!!",1400);
              }
              if(lastHolder==='bot') {
                scoreBot++; showMessage("BUT du bot !",1400);
              }
              updateScoreUI();
              setTimeout(()=>{
                resetBall();
                resetBot();
                resetGardien();
                this.goal = false;
              }, 1200);
            }
          }
        });
      }
    });
    // --- D√©marrage & Restart
    window.addEventListener('DOMContentLoaded', ()=>{
      let scoreDiv = document.createElement('div');
      scoreDiv.id = "score-ui"; scoreDiv.className = "score-ui";
      document.body.appendChild(scoreDiv);
      let timerDiv = document.createElement('div');
      timerDiv.id = "timer-ui"; timerDiv.className = "timer-ui";
      document.body.appendChild(timerDiv);
      let helpDiv = document.createElement('div');
      helpDiv.className = "help-ui";
      helpDiv.innerHTML = "<b>Handball VR</b><br>Stick gauche/ZQSD‚ÄØ: D√©placement<br>Appui stick/Shift‚ÄØ: Sprint<br>Stick droit/E/R‚ÄØ: Rotation<br>Bouton A/X/Espace‚ÄØ: Saut<br>Attrape/lance le ballon‚ÄØ: main/trigger/clic<br>Marque plus que le bot !<br><i>Restart = touche R</i>";
      document.body.appendChild(helpDiv);
      setTimeout(()=>{helpDiv.style.display="none"}, 14000);
      restartGame(); updateScoreUI(); updateTimerUI();
      setTimeout(()=>{playing=true;startTimer();botThink();},1200);
      document.body.onkeydown = e => { if(e.key=="r"||e.key=="R") window.location.reload(); }
    });
  </script>
</head>
<body>
  <a-scene physics="gravity:-9.8; restitution:0.81; friction:0.32;" background="color: #e5f6ff" loading-screen="enabled:false">
    <a-assets>
      <audio id="goal-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12e6c7b2bb.mp3"></audio>
      <audio id="ambiance" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" preload="auto"></audio>
    </a-assets>
    <!-- Terrain handball officiel -->
    <a-box position="0 0 0" width="14" height="0.12" depth="28" color="#d3f1ff" static-body></a-box>
    <a-ring position="0 0.07 10.8" rotation="-90 0 0" radius-inner="2.1" radius-outer="2.13" color="#fff" segments-theta="64"></a-ring>
    <a-ring position="0 0.07 -10.8" rotation="-90 0 0" radius-inner="2.1" radius-outer="2.13" color="#fff" segments-theta="64"></a-ring>
    <a-ring position="0 0.07 0" rotation="-90 0 0" radius-inner="5.8" radius-outer="5.85" color="#fff" segments-theta="64"></a-ring>
    <!-- But avant -->
    <a-box position="0 1 10.8" width="3" height="2" depth="0.25" color="#1e90ff" static-body></a-box>
    <a-box position="-1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="1.45 1 10.8" width="0.1" height="2" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-box position="0 2 10.8" width="3" height="0.09" depth="0.27" color="#1e90ff" static-body></a-box>
    <a-plane position="0 1.01 11" width="2.8" height="1.95" rotation="0 0 0" color="#fff" opacity="0.13"></a-plane>
    <a-box id="goal-trigger" position="0 1 10.6" width="2.6" height="1.75" depth="0.1" opacity="0" visible="false" static-body></a-box>
    <!-- Gardien IA -->
    <a-cylinder id="gardien" position="0 1 10.3" radius="0.32" height="1.8" color="#eaf05a" segments-radial="6"></a-cylinder>
    <a-sphere position="0 1.82 10.3" radius="0.19" color="#bab600"></a-sphere>
    <!-- Scoreboard g√©ant -->
    <a-entity id="scoreboard" position="0 2.9 8.2" text="value: 0 - 0; color: #1e90ff; width: 4.5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt"></a-entity>
    <!-- Bot adverse -->
    <a-cylinder id="bot" position="0 1 6" radius="0.37" height="2" color="#aad4f7" segments-radial="6"></a-cylinder>
    <a-sphere position="0 2.24 6.47" radius="0.27" color="#0a3a74"></a-sphere>
    <!-- Ballon handball physique -->
    <a-sphere id="handball" class="raycastable grabbable" position="0 1.2 0" radius="0.23" color="#ffb300" dynamic-body="mass: 0.36; linearDamping:0.07; angularDamping:0.13; restitution:0.81; friction:0.33" super-hands throwable goal-detect="scoreEl: #score-text" shadow="cast:true"></a-sphere>
    <!-- Rig joueur + mains VR directionnelles -->
    <a-entity id="rig" position="0 1.6 -7" foot-move>
      <a-entity id="camera" camera wasd-controls look-controls position="0 0 0"></a-entity>
      <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: highPoly; color: #e5b285" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8"></a-entity>
      <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: highPoly; color: #d7a878" shadow="cast: true" super-hands raycaster="objects: .raycastable, .grabbable; showLine: true; lineColor: #228b22" line="color: #228b22; opacity: 0.8"></a-entity>
    </a-entity>
    <a-entity id="score-text" position="0 3.5 3" text="value: 0; color: #1e90ff; width: 4.5; align: center; font: https://cdn.aframe.io/fonts/Exo2Bold.fnt" visible="true"></a-entity>
    <a-sky color="#e5f6ff"></a-sky>
  </a-scene>
  <audio id="ambiance-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12e9c1f3c3.mp3" autoplay loop></audio>
</body>
</html>
