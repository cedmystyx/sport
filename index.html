<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Section Sportive - Lycée Louis de Cormontaigne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <style>
    html, body {
      margin: 0; height: 100%; overflow: hidden;
      background: #222;
      font-family: Arial, sans-serif;
      color: white;
    }
    #startScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #111, #222);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 10; text-align: center;
    }
    #startButton {
      margin-top: 20px;
      padding: 14px 30px;
      font-size: 1.3em;
      background: #007acc;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #startButton:hover {
      background: #005f99;
    }
    #menu {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 12px 25px;
      border-radius: 10px;
      display: none;
      gap: 15px;
      z-index: 5;
      user-select: none;
    }
    #menu button {
      background: #007acc;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: 1em;
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #menu button:hover {
      background: #005f99;
    }
  </style>
</head>
<body>

<div id="startScreen">
  <h1>Section Sportive - Lycée Louis de Cormontaigne</h1>
  <p>Entrez dans une expérience sportive immersive en réalité virtuelle</p>
  <button id="startButton">Entrer</button>
</div>

<div id="menu">
  <button onclick="teleportTo('foot')">Football</button>
  <button onclick="teleportTo('basket')">Basketball</button>
  <button onclick="teleportTo('hand')">Handball</button>
  <button onclick="teleportTo('athle')">Athlétisme</button>
</div>

<a-scene embedded background="color: #181818" shadow="type: pcfsoft" style="width:100vw; height:100vh; display:none" id="scene">

  <a-assets>
    <!-- FOOTBALL : ton modèle footballeur animé -->
    <a-asset-item id="footPlayer" src="personnage/goal.glb"></a-asset-item>
    <!-- Basket : Soldier en animation de marche -->
    <a-asset-item id="basketPlayer" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Soldier/glTF/Soldier.glb"></a-asset-item>
    <!-- Handball : Soldier animé -->
    <a-asset-item id="handPlayer" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Soldier/glTF/Soldier.glb"></a-asset-item>
    <!-- Athlétisme : Running Man -->
    <a-asset-item id="athlePlayer" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/RunningMan/glTF/RunningMan.glb"></a-asset-item>

    <!-- Sons ambiance stade -->
    <audio id="ambiance" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c7a7c2f4e0.mp3"></audio>
  </a-assets>

  <!-- Caméra avec son ambiant -->
  <a-entity id="cameraRig" position="0 1.6 15">
    <a-entity camera look-controls wasd-controls>
      <a-entity sound="src: #ambiance; autoplay: false; loop: true; positional: true; volume: 0.3"></a-entity>
    </a-entity>
  </a-entity>

  <!-- Lumières -->
  <a-light type="ambient" color="#555"></a-light>
  <a-light type="directional" color="#fff" position="5 10 7" intensity="0.8" cast-shadow="true"></a-light>

  <!-- Sol global gris béton -->
  <a-plane rotation="-90 0 0" width="100" height="100" color="#2b2b2b" shadow="receive: true"></a-plane>

  <!-- FOOTBALL -->
  <a-entity id="foot" position="-20 0 -15">
    <a-text value="Football" position="0 3 0" align="center" color="#00ff00" width="6"></a-text>
    <a-box color="#1a3d1a" width="10" height="0.1" depth="18" position="0 0 0"></a-box>

    <!-- Footballeur animé avec ballon attaché au bone RightFoot -->
    <a-entity id="footPlayerEntity" position="-2 0 0" scale="1.5 1.5 1.5" 
              gltf-model="#footPlayer" 
              animation-mixer="clip: *; loop: repeat; crossFadeDuration: 1.0" 
              class="clickable">
      <a-sphere id="footBall" radius="0.2" color="#fff" shadow="cast: true; receive: false"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"
                attach-to-bone="modelSelector: #footPlayerEntity; boneName: RightFoot">
      </a-sphere>
    </a-entity>
  </a-entity>

  <!-- BASKETBALL -->
  <a-entity id="basket" position="20 0 -15">
    <a-text value="Basketball" position="0 3 0" align="center" color="#ff8000" width="6"></a-text>
    <a-box color="#4a2e00" width="10" height="0.1" depth="18" position="0 0 0"></a-box>
    <a-sphere color="#e67e22" radius="0.45" position="1 0.45 0" segments-height="8" segments-width="8" animation="property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear"></a-sphere>
    <a-entity gltf-model="#basketPlayer" position="-2 0 0" scale="0.03 0.03 0.03" animation-mixer="clip: *; loop: repeat; crossFadeDuration: 1.0"></a-entity>
  </a-entity>

  <!-- HANDBALL -->
  <a-entity id="hand" position="-20 0 15">
    <a-text value="Handball" position="0 3 0" align="center" color="#cc3399" width="6"></a-text>
    <a-box color="#3b0f3b" width="8" height="0.1" depth="14" position="0 0 0"></a-box>
    <a-sphere color="#cc3366" radius="0.35" position="1 0.35 0" segments-height="8" segments-width="8" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear"></a-sphere>
    <a-entity gltf-model="#handPlayer" position="-2 0 0" scale="0.03 0.03 0.03" animation-mixer="clip: *; loop: repeat; crossFadeDuration: 1.0"></a-entity>
  </a-entity>

  <!-- ATHLÉTISME -->
  <a-entity id="athle" position="20 0 15">
    <a-text value="Athlétisme" position="0 3 0" align="center" color="#3399cc" width="6"></a-text>
    <a-box color="#111111" width="16" height="0.1" depth="4" position="0 0 0"></a-box>
    <a-entity gltf-model="#athlePlayer" position="-4 0 0" scale="1.3 1.3 1.3" animation-mixer="clip: *; loop: repeat; crossFadeDuration: 1.0"></a-entity>
  </a-entity>

  <!-- Tribune simplifiée -->
  <a-box position="0 0 -30" width="40" height="3" depth="3" color="#111111" shadow></a-box>

</a-scene>

<script>
  const startBtn = document.getElementById('startButton');
  const startScreen = document.getElementById('startScreen');
  const scene = document.getElementById('scene');
  const menu = document.getElementById('menu');
  const cameraRig = document.getElementById('cameraRig');

  startBtn.addEventListener('click', () => {
    startScreen.style.display = 'none';
    scene.style.display = 'block';
    menu.style.display = 'flex';
    // Play ambiance sound
    const soundComp = scene.querySelector('[sound]').components.sound;
    if (soundComp) soundComp.playSound();
  });

  function teleportTo(zoneId) {
    const target = document.getElementById(zoneId);
    if (!target) return;
    const pos = target.getAttribute('position');
    cameraRig.setAttribute('position', { x: pos.x, y: 1.6, z: pos.z + 7 });
  }


  // Composant attach-to-bone
  AFRAME.registerComponent('attach-to-bone', {
    schema: {
      modelSelector: {type: 'selector'},
      boneName: {type: 'string'}
    },
    init() {
      this.model = this.data.modelSelector.getObject3D('mesh') || this.data.modelSelector.getObject3D('gltf');
      if (!this.model) {
        console.warn('Modèle non chargé ou incorrect');
        return;
      }
      this.bone = null;
      this.el.object3D.visible = false;
    },
    tick() {
      if (!this.bone) {
        this.bone = null;
        this.data.modelSelector.getObject3D('mesh').traverse((obj) => {
          if (obj.isBone && obj.name === this.data.boneName) {
            this.bone = obj;
          }
        });
        if (!this.bone) return;
        this.el.object3D.visible = true;
      }
      // Copier position et rotation os dans ballon
      this.el.object3D.position.copy(this.bone.getWorldPosition(new THREE.Vector3()));
      this.el.object3D.quaternion.copy(this.bone.getWorldQuaternion(new THREE.Quaternion()));
    }
  });

  // Gestion tir ballon

  const footPlayerEntity = document.getElementById('footPlayerEntity');
  const footBall = document.getElementById('footBall');
  let isShooting = false;
  const shootDuration = 2000; // Durée du tir en ms
  const shootDistance = 8;    // Distance parcourue par le ballon

  // Fonction pour lancer le tir
  function shootBall() {
    if (isShooting) return;
    isShooting = true;

    // Récupérer animation mixer du joueur
    const mixerComp = footPlayerEntity.components['animation-mixer'];
    if (mixerComp) {
      mixerComp.stopAllAction();
      // Adapte le nom du clip "shoot" au tien
      mixerComp.playAction('shoot' || mixerComp.clips[0].name, 0, 1);
    }

    // Détache le ballon du joueur pour l'animer
    if (footBall.parentElement === footPlayerEntity) {
      footPlayerEntity.removeChild(footBall);
      scene.appendChild(footBall);
    }

    // Position monde initiale du ballon
    const ballWorldPos = new THREE.Vector3();
    footBall.object3D.getWorldPosition(ballWorldPos);
    footBall.setAttribute('position', ballWorldPos);

    const startPos = ballWorldPos.clone();

    // Calcul direction tir (devant joueur)
    const playerRotY = footPlayerEntity.object3D.rotation.y;
    const dirX = -Math.sin(playerRotY);
    const dirZ = -Math.cos(playerRotY);

    const startTime = performance.now();

    // Enlever animation rotation ballon pendant tir
    footBall.removeAttribute('animation');

    // Animation déplacement du ballon
    function animateBall(time) {
      const elapsed = time - startTime;
      if (elapsed > shootDuration) {
        // Fin tir, rattacher ballon au joueur
        footBall.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
        footBall.setAttribute('position', {x: 0, y: 0, z: 0}); // reset position locale

        footPlayerEntity.appendChild(footBall);

        if (mixerComp) {
          mixerComp.stopAllAction();
          mixerComp.playAction(mixerComp.clips[0].name, 0, Infinity);
        }

        isShooting = false;
        return;
      }

      const progress = elapsed / shootDuration;
      const height = 1.5 * Math.sin(Math.PI * progress);

      footBall.setAttribute('position', {
        x: startPos.x + dirX * shootDistance * progress,
        y: startPos.y + height,
        z: startPos.z + dirZ * shootDistance * progress
      });

      requestAnimationFrame(animateBall);
    }

    requestAnimationFrame(animateBall);
  }

  // Événement click sur joueur
  footPlayerEntity.addEventListener('click', () => {
    shootBall();
  });

  // Tir barre espace
  window.addEventListener('keydown', e => {
    if (e.code === 'Space') {
      shootBall();
    }
  });

</script>

</body>
</html>
