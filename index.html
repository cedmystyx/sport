<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lycée Louis de Cormontaigne – Section Sportive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.0.1/dist/aframe-particle-system-component.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: black; font-family: Arial, sans-serif; }
    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; color: #00ffff; display: flex; justify-content: center; align-items: center;
      z-index: 1000; font-size: 24px; letter-spacing: 2px;
      animation: pulse 1.2s infinite alternate;
    }
    @keyframes pulse {
      to { color: #ff0066; text-shadow: 0 0 32px #00ffff, 0 0 16px #ff0066; }
    }
    #controls, #header {
      position: fixed; left: 20px; z-index: 100;
      transition: opacity 0.8s;
    }
    #controls {
      top: 88px; color: #00ffff;
      background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; font-size: 14px;
      box-shadow: 0 2px 12px #00ffff44;
      opacity: 0;
      transition: opacity 1.2s;
    }
    #header {
      top: 20px;
      color: #fff;
      background: rgba(0,0,0,0.92);
      padding: 18px 30px;
      border-radius: 10px;
      font-size: 2.1rem;
      font-family: 'Segoe UI', Arial, sans-serif;
      letter-spacing: 1.5px;
      box-shadow: 0 3px 24px #00ffff44;
      border-left: 5px solid #00ffff;
      text-shadow: 0 2px 20px #00ffff88;
      max-width: 90vw;
      animation: header-fade 1.9s ease;
    }
    @keyframes header-fade {
      0% { filter: blur(12px); opacity: 0; }
      100% { filter: blur(0); opacity: 1; }
    }
    #subtitle {
      display: block;
      font-size: 1.1rem;
      color: #00ffff;
      margin-top: 8px;
      letter-spacing: 1px;
      font-weight: bold;
      text-shadow: 0 1px 8px #00ffff77;
    }
    #welcome {
      display: block;
      font-size: 1.15rem;
      color: #fff;
      margin-top: 14px;
      letter-spacing: 0.5px;
      font-weight: 400;
      text-shadow: 0 1px 10px #00224488;
    }
    .neon-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 20px;
      background: transparent;
      color: #00ffff;
      border: 2px solid #00ffff;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 0 12px #00ffff77;
      transition: background 0.3s, color 0.3s, transform 0.2s;
      animation: btnpulse 2s infinite alternate;
    }
    .neon-btn:hover {
      background: #00ffff33;
      color: #fff;
      transform: scale(1.06) rotate(-2deg);
    }
    @keyframes btnpulse {
      0% { box-shadow: 0 0 12px #00ffff77; }
      100% { box-shadow: 0 0 28px #ff006666, 0 0 18px #00ffff99; }
    }
    @media (max-width: 600px) {
      #header { font-size: 1.2rem; padding:10px 8px; }
      #controls { font-size: 12px; }
    }
  </style>
</head>
<body>
<div id="loading">Chargement de la ville...</div>
<div id="header">
  Lycée Louis de Cormontaigne – Section Sportive
  <span id="subtitle">Ville numérique & Sport</span>
  <span id="welcome">Bienvenue ! Explorez et découvrez nos activités.</span>
  <button class="neon-btn" onclick="resetView()">Revenir au centre</button>
</div>
<div id="controls" style="opacity:0">
  <b>Contrôles :</b><br>
  Déplace-toi : <span style="color:#ff0066">Z Q S D</span> ou <span style="color:#ff0066">Flèches</span> <br>
  Regarde autour : <span style="color:#ff0066">Souris</span><br>
  Voler / descendre : <span style="color:#ff0066">Espace / Shift</span><br>
  Recentrer: <span class="neon-btn" style="padding:2px 10px; font-size:0.95em;" onclick="resetView()">Centre</span>
</div>
<a-scene loading-screen="enabled: false" shadow="type: pcfsoft">
  <a-sky color="#000011" material="shader: gradient; topColor: #000033; bottomColor: #000000"></a-sky>
  <a-entity id="cameraRig" position="0 1.5 0">
    <a-entity id="mainCamera" camera look-controls wasd-controls="acceleration: 20; fly: true" position="0 0 0"></a-entity>
  </a-entity>
  <a-entity light="type: ambient; color: #002244; intensity: 0.4"></a-entity>
  <a-entity light="type: directional; color: #00ffff; intensity: 0.7" position="20 30 20"></a-entity>
  <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200" color="#000000"
           material="metalness: 0.9; roughness: 0.1; emissive: #001122; emissiveIntensity: 0.2"
           shadow="receive: true"></a-plane>
  <a-entity id="grid" generate-grid></a-entity>
  <a-entity id="city" generate-city-cormontaigne></a-entity>
  <a-entity particle-system="preset: dust; particleCount: 36; color: #00ffff,#ff0066; size: 0.36; accelerationValue: 0 0.10 0"></a-entity>
  <!-- Effet d'animation du logo sportif flottant -->
  <a-entity position="0 8.3 -25" animation="property: position; dir: alternate; to: 0 8.9 -25; dur: 2200; loop: true; easing: easeInOutSine">
    <a-plane width="6" height="6" color="#000" opacity="0.77" material="shader: flat; side: double; transparent: true; emissive: #00ffff; emissiveIntensity: 0.12"></a-plane>
    <!-- Logo sportif central dynamique -->
    <a-image src="https://upload.wikimedia.org/wikipedia/commons/7/70/Sport_basketball.svg"
      width="3.3" height="3.3" position="0 0 0.01" opacity="0.88" transparent="true"
      animation="property: rotation; to: 0 360 0; loop: true; dur: 10500; easing: linear">
    </a-image>
  </a-entity>
  <!-- Panneau de bienvenue flottant en 3D -->
  <a-entity position="0 4.5 -25" rotation="0 0 0" animation="property: position; dir: alternate; to: 0 5.2 -25; dur: 1600; loop: true; easing: easeInOutSine">
    <a-plane width="24" height="6.8" color="#000" opacity="0.90" material="shader: flat; side: double; transparent: true; emissive: #00ffff; emissiveIntensity: 0.09"></a-plane>
    <a-text value="Bienvenue au Lycée Louis de Cormontaigne\nSection Sportive" width="22" align="center" color="#00ffff" position="0 1.2 0.01" side="double" anchor="center" font="mozillavr" shader="msdf"
      animation="property: scale; dir: alternate; to: 1.04 1.04 1.04; dur: 2100; loop: true; easing: easeInOutSine"></a-text>
    <a-text value="Explore la ville numérique et la passion du sport !" width="21" align="center" color="#fff" position="0 -1.2 0.01" side="double" anchor="center" font="mozillavr" shader="msdf"
      animation="property: scale; dir: alternate; to: 1.04 1.04 1.04; dur: 1900; loop: true; easing: easeInOutSine"></a-text>
  </a-entity>
  <script>
    // Grille cyberpunk au sol
    AFRAME.registerComponent('generate-grid', {
      init: function () {
        const container = this.el;
        const gridSize = 100, spacing = 10;
        for (let i = -gridSize; i <= gridSize; i += spacing) {
          const line = document.createElement('a-entity');
          line.setAttribute('geometry', { primitive: 'box', width: gridSize*2, height: 0.04, depth: 0.08 });
          line.setAttribute('position', `0 0.01 ${i}`);
          line.setAttribute('material', { color: '#00ffff', emissive: '#00ffff', emissiveIntensity: 0.3, opacity: 0.22, transparent: true });
          container.appendChild(line);
        }
        for (let i = -gridSize; i <= gridSize; i += spacing) {
          const line = document.createElement('a-entity');
          line.setAttribute('geometry', { primitive: 'box', width: 0.08, height: 0.04, depth: gridSize*2 });
          line.setAttribute('position', `${i} 0.01 0`);
          line.setAttribute('material', { color: '#00ffff', emissive: '#00ffff', emissiveIntensity: 0.3, opacity: 0.22, transparent: true });
          container.appendChild(line);
        }
      }
    });

    // Gestion du loading
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('controls').style.opacity = '1';
      }, 1200);
    });

    // Reset camera position
    function resetView() {
      const rig = document.getElementById('cameraRig');
      if (rig) rig.setAttribute('position', '0 1.5 0');
      const cam = document.getElementById('mainCamera');
      if (cam && cam.components['look-controls']) {
        cam.components['look-controls'].yawObject.rotation.set(0, 0, 0);
        cam.components['look-controls'].pitchObject.rotation.set(0, 0, 0);
      }
    }
    window.resetView = resetView;

    // Texture Matrix mutualisée, descente sur 10 secondes (indépendant du processeur)
    let sharedMatrixTexture = null;
    (function createSharedMatrixTexture() {
      const canvas = document.createElement('canvas');
      canvas.width = 128;
      canvas.height = 256;
      const ctx = canvas.getContext('2d');
      const chars = "アカサタナハマヤラワ0123456789ABCDEF";
      const fontSize = 8;
      const columns = Math.floor(canvas.width / fontSize);
      const rows = Math.floor(canvas.height / fontSize);
      const colOffsets = [];
      for (let i = 0; i < columns; i++) colOffsets.push(Math.random());
      sharedMatrixTexture = new THREE.CanvasTexture(canvas);
      sharedMatrixTexture.wrapS = THREE.RepeatWrapping;
      sharedMatrixTexture.wrapT = THREE.RepeatWrapping;
      sharedMatrixTexture.repeat.set(1, 2);

      function animateMatrix() {
        const now = performance.now();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.22)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = `${fontSize}px monospace`;

        const T = 10000;
        const phase = (now % T) / T;

        for (let i = 0; i < columns; i++) {
          const colPhase = ((phase + colOffsets[i]) % 1);
          const y = colPhase * canvas.height;
          ctx.fillStyle = `rgba(0,220,110,0.58)`;
          for (let step = 0; step < rows; step++) {
            const char = chars[Math.floor(Math.random() * chars.length)];
            let dropY = ((y + step * fontSize) % canvas.height);
            ctx.fillText(char, i * fontSize, dropY);
          }
        }
        sharedMatrixTexture.needsUpdate = true;
        requestAnimationFrame(animateMatrix);
      }
      animateMatrix();
    })();

    // Ville Cormontaigne : buildings sportifs et Matrix
    AFRAME.registerComponent('generate-city-cormontaigne', {
      init: function () {
        const container = this.el;
        const spacing = 10;
        const gridSize = 8;
        const emptyRadius = 6;
        for (let x = -gridSize; x <= gridSize; x += 2) {
          for (let z = -gridSize; z <= gridSize; z += 2) {
            if (Math.abs(x) <= emptyRadius && Math.abs(z) <= emptyRadius) continue;
            const width = 2.4 + Math.random() * 4.2;
            const depth = 2.3 + Math.random() * 3.8;
            const height = 22 + Math.random() * 64 + Math.random()*24*Math.random();
            const posX = x * spacing + (Math.random()-0.5)*2.3;
            const posZ = z * spacing + (Math.random()-0.5)*2.3;
            const animationDuration = 7000 + Math.random()*4000;
            this.createBuilding(container, posX, posZ, width, depth, height, animationDuration);
          }
        }
      },
      createBuilding: function(container, x, z, width, depth, height, animationDuration) {
        const building = document.createElement('a-entity');
        building.setAttribute('position', `${x} 0 ${z}`);
        // Boîte principale
        const mainBox = document.createElement('a-box');
        mainBox.setAttribute('width', width.toFixed(2));
        mainBox.setAttribute('depth', depth.toFixed(2));
        mainBox.setAttribute('height', height.toFixed(2));
        mainBox.setAttribute('position', `0 ${height/2} 0`);
        mainBox.setAttribute('material', {
          color: '#00ffff',
          opacity: 0.33,
          transparent: true,
          emissive: '#002244',
          emissiveIntensity: 0.16,
          metalness: 0.47,
          roughness: 0.3
        });
        mainBox.setAttribute('shadow', 'cast: true; receive: true');
        mainBox.setAttribute('animation__float', {
          property: 'position',
          to: `0 ${height/2} 0`,
          from: `0 ${height/2 - 2} 0`,
          dir: 'alternate',
          dur: animationDuration,
          loop: true,
          easing: 'easeInOutSine'
        });
        building.appendChild(mainBox);
        // Façades Matrix
        const faces = [
          { pos: [0, height/2, depth/2 + 0.05], rot: [0, 0, 0], w: width, h: height },
          { pos: [0, height/2, -depth/2 - 0.05], rot: [0, 180, 0], w: width, h: height },
          { pos: [width/2 + 0.05, height/2, 0], rot: [0, -90, 0], w: depth, h: height },
          { pos: [-width/2 - 0.05, height/2, 0], rot: [0, 90, 0], w: depth, h: height }
        ];
        faces.forEach(face => {
          const panel = document.createElement('a-plane');
          panel.setAttribute('width', face.w.toFixed(2));
          panel.setAttribute('height', face.h.toFixed(2));
          panel.setAttribute('position', `${face.pos[0]} ${face.pos[1]} ${face.pos[2]}`);
          panel.setAttribute('rotation', `${face.rot[0]} ${face.rot[1]} ${face.rot[2]}`);
          panel.setAttribute('material', {
            shader: 'flat',
            side: 'double',
            transparent: true,
            opacity: 0.36
          });
          panel.setAttribute('animation__float', {
            property: 'position',
            to: `${face.pos[0]} ${face.pos[1]} ${face.pos[2]}`,
            from: `${face.pos[0]} ${face.pos[1] - 2} ${face.pos[2]}`,
            dir: 'alternate',
            dur: animationDuration,
            loop: true,
            easing: 'easeInOutSine'
          });
          panel.addEventListener('loaded', () => {
            const mesh = panel.getObject3D('mesh');
            if (mesh && mesh.material) {
              mesh.material.map = sharedMatrixTexture;
              mesh.material.needsUpdate = true;
            }
          });
          building.appendChild(panel);
        });
        // Antenne sur le toit (rare, clin d'œil sport)
        if (Math.random() > 0.8) {
          const antenna = document.createElement('a-cylinder');
          antenna.setAttribute('radius', '0.13');
          antenna.setAttribute('height', '3.5');
          antenna.setAttribute('position', `0 ${height + 1.8} 0`);
          antenna.setAttribute('color', '#ff0066');
          antenna.setAttribute('material', 'emissive: #ff0066; emissiveIntensity: 0.4');
          antenna.setAttribute('animation__float', {
            property: 'position',
            to: `0 ${height + 1.8} 0`,
            from: `0 ${height + 1.8 - 2} 0`,
            dir: 'alternate',
            dur: animationDuration,
            loop: true,
            easing: 'easeInOutSine'
          });
          building.appendChild(antenna);
        }
        container.appendChild(building);
      }
    });

    // Shader dégradé ciel
    AFRAME.registerShader('gradient', {
      schema: { topColor: {type: 'color', default: '#000033'}, bottomColor: {type: 'color', default: '#000000'} },
      vertexShader: `
        varying vec2 vUv;
        void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);}
      `,
      fragmentShader: `
        uniform vec3 topColor;
        uniform vec3 bottomColor;
        varying vec2 vUv;
        void main() { gl_FragColor = vec4(mix(bottomColor, topColor, vUv.y), 1.0);}
      `
    });

    // Performances
    const scene = document.querySelector('a-scene');
    scene.addEventListener('loaded', function () {
      if(scene.renderer) {
        scene.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        scene.renderer.shadowMap.enabled = true;
        scene.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      }
    });
    window.addEventListener('resize', function() {
      const scene = document.querySelector('a-scene');
      if (scene.renderer) {
        scene.renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
  </script>
</a-scene>
</body>
</html>
